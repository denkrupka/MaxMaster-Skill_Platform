# ТЕХНИЧЕСКОЕ ЗАДАНИЕ

## Автоматизированная система расчёта электромонтажных работ «ЭлектроСмета»

**Версия документа:** 1.0  
**Дата создания:** 06.02.2026  
**Статус:** Проект  

---

# СОДЕРЖАНИЕ

1. Введение и общее описание системы
2. Термины и определения
3. Функциональные требования
4. Описание бизнес-процессов
5. Требования к интерфейсу пользователя
6. Модель данных
7. API-спецификация
8. Алгоритмы и бизнес-логика
9. Требования к интеграциям
10. Нефункциональные требования
11. Технологический стек
12. Этапы разработки и внедрения
13. Риски и ограничения
14. Приложения

---

# 1. ВВЕДЕНИЕ И ОБЩЕЕ ОПИСАНИЕ СИСТЕМЫ

## 1.1. Цели и задачи автоматизации

Система «ЭлектроСмета» предназначена для автоматизации процесса расчёта стоимости электромонтажных работ — от приёма запроса клиента до формирования коммерческого предложения (КП). 

**Основные цели:**

1. Сокращение времени подготовки коммерческого предложения с 3–5 рабочих дней до 1–2 часов.
2. Исключение ошибок, связанных с пропуском позиций работ, материалов или объёмов.
3. Стандартизация процесса расчёта: единый порядок действий для всех специалистов по сметам.
4. Обеспечение прозрачности: все данные хранятся централизованно, руководство видит текущий статус каждого запроса.
5. Формирование базы знаний: справочники работ, материалов, шаблонных заданий актуализируются и переиспользуются.

**Основные задачи:**

- Регистрация входящих запросов на расчёт от клиентов.
- Заполнение формуляра выполняемых работ (электронный аналог Excel-формуляра).
- Автоматическое формирование сметы на основании заполненного формуляра.
- Редактирование сметы специалистом (добавление/удаление позиций, корректировка объёмов, цен).
- Формирование коммерческого предложения на основании утверждённой сметы.
- Управление справочниками работ, материалов, техники и прайс-листами.
- Отчётность и аналитика.

## 1.2. Описание текущего процесса (As-Is)

Текущий процесс выглядит следующим образом:

**Шаг 1.** Менеджер отдела продаж получает запрос от клиента (по телефону, e-mail, встреча). Менеджер фиксирует основные параметры объекта: тип здания (промышленное / жилое / офисное), площадь, этажность, тип стен, высота потолков.

**Шаг 2.** Менеджер передаёт информацию специалисту по коштоприсованию (отдел KD2, KD4, KB5, KB10, KB11, KB12). Передача осуществляется через электронную почту или устно.

**Шаг 3.** Специалист открывает один из двух Excel-формуляров:
- «Промышленные здания — формуляр для выполняемых работ» (листы IE и IT).
- «Жилые дома и офисы — формуляр для выполняемых работ» (листы IE, IT и Словарь).

Формуляр представляет собой матрицу, где по вертикали расположены помещения и элементы установок (узиом, помещения технические, освещение, розетки, распределительные шкафы и т.д.), а по горизонтали — виды работ (штробление, отделка штроб, прокладка кабельных трасс, прокладка кабелей различными способами, монтаж приёмников и т.д.).

**Шаг 4.** Специалист ставит отметки «X» на пересечениях строк и столбцов, обозначая, какие работы в каких помещениях и каким способом будут выполняться.

**Шаг 5.** На основании заполненного формуляра специалист вручную формирует смету в Excel-шаблоне (файлы «Szablon do kosztorysów.xlsx» или «Szablon do kosztorysów hala.xlsx»), который содержит столбцы: Помещение/Элемент установки, Задание, Материал, Единица измерения, Количество, Цена единицы (работа), Стоимость (работа), Цена единицы (материал), Стоимость (материал), Итоговая стоимость, Конечный результат.

**Шаг 6.** Специалист передаёт смету руководителю Бюро планирования для проверки и утверждения.

**Шаг 7.** После утверждения формируется коммерческое предложение и направляется клиенту.

**Проблемы текущего процесса:**
- Высокая трудоёмкость: ручное заполнение формуляра и сметы занимает до 5 рабочих дней.
- Ошибки: пропуск позиций работ, неверные объёмы, неактуальные цены.
- Отсутствие единой базы данных: каждый специалист работает в своих файлах.
- Сложность контроля: руководство не видит статус работы в реальном времени.
- Потеря данных: файлы не версионируются, история изменений не ведётся.

## 1.3. Описание целевого процесса (To-Be)

**Шаг 1.** Менеджер или специалист создаёт запрос в системе, указывая данные клиента и параметры объекта.

**Шаг 2.** Система предлагает соответствующий формуляр (промышленный или жилой/офисный, электроустановки IE или телетехника IT).

**Шаг 3.** Специалист заполняет электронный формуляр, проставляя отметки на пересечениях работ и помещений. Система контролирует полноту заполнения, подсвечивая пропущенные обязательные поля.

**Шаг 4.** По нажатию кнопки «Сформировать смету» система автоматически:
- Определяет все отмеченные пересечения (помещение × работа).
- Для каждого пересечения находит соответствующее шаблонное задание в справочнике.
- Формирует позиции сметы с единицами измерения, базовыми ценами и нормами из справочника.

**Шаг 5.** Специалист просматривает автоматически сформированную смету, корректирует количество, добавляет или удаляет позиции, указывает конкретные материалы и технику.

**Шаг 6.** Система рассчитывает итоговую стоимость по формулам.

**Шаг 7.** Специалист нажимает «Сформировать КП», система генерирует документ коммерческого предложения.

**Шаг 8.** КП проходит процедуру утверждения и отправляется клиенту.

## 1.4. Ожидаемые результаты внедрения

| Показатель | Текущее значение | Целевое значение |
|---|---|---|
| Время подготовки сметы | 3–5 рабочих дней | 2–4 часа |
| Количество пропущенных позиций | до 15% | менее 1% |
| Время формирования КП | 1 рабочий день | 15 минут |
| Повторное использование данных | Нет | 100% (из справочников) |
| Прозрачность процесса | Низкая | Полная (дашборд статусов) |

## 1.5. Границы системы

**Входит в систему:**
- Приём и регистрация запросов на расчёт.
- Электронный формуляр работ.
- Автоматическое формирование сметы.
- Ручная корректировка сметы.
- Формирование КП.
- Справочники работ, материалов, техники, прайс-листы.
- Управление пользователями и правами доступа.
- Отчётность и аналитика.
- Экспорт/импорт данных в Excel.

**Не входит в систему:**
- CRM-функционал (управление отношениями с клиентами).
- Бухгалтерский учёт и выставление счетов.
- Управление проектами (Gantt-диаграммы, ресурсное планирование).
- Управление складом и логистикой.
- Мобильное приложение для монтажников на объекте.

---

# 2. ТЕРМИНЫ И ОПРЕДЕЛЕНИЯ

## 2.1. Глоссарий

| Термин | Определение |
|---|---|
| Формуляр выполняемых работ | Электронная матрица, в которой по вертикали расположены помещения/элементы установки, а по горизонтали — виды работ. Заполняется отметками «X» для обозначения объёма работ. |
| Смета (Kosztorys) | Документ, содержащий перечень работ, материалов и техники с указанием объёмов, цен и итоговой стоимости. |
| Коммерческое предложение (КП) | Официальный документ для клиента, содержащий описание работ и итоговую стоимость. |
| IE (Instalacje Elektryczne) | Электрические установки — раздел формуляра, охватывающий силовые и осветительные электроустановки. |
| IT (Instalacje Teletechniczne) | Телетехнические установки — раздел формуляра, охватывающий слаботочные системы (SAP, SSO, DSO, CCTV, KD, BMS и т.д.). |
| Шаблонное задание | Предварительно настроенная связка: вид работ + материалы + техника + нормы времени + единица измерения. Используется для автоматического формирования позиций сметы. |
| Маппинг | Правило соответствия между отметкой в формуляре (пересечение помещения и работы) и шаблонным заданием в справочнике. |
| Прайс-лист | Таблица цен на виды работ и материалы, действующая в определённый период. |
| WLZ (Wewnętrzna Linia Zasilająca) | Внутренняя линия питания — кабель от ввода в здание до распределительного щита. |
| ZK (Złącze Kablowe) | Кабельный ввод — точка подключения к внешней сети электроснабжения. |
| TM (Tablica Mieszkaniowa) | Квартирный распределительный щит. |
| TT (Tablica Teletechniczna) | Телекоммуникационный щит квартиры. |

## 2.2. Аббревиатуры телетехнических систем

| Аббревиатура | Полное наименование | Описание |
|---|---|---|
| SAP | System Alarmu Pożarowego | Система пожарной сигнализации |
| SSO | System Sygnalizacji Optycznej | Система оптической сигнализации |
| DSO | Dźwiękowy System Ostrzegawczy | Звуковая система оповещения |
| SSWiN | System Sygnalizacji Włamania i Napadu | Система охранной сигнализации |
| CCTV | Closed Circuit Television | Система видеонаблюдения |
| KD | Kontrola Dostępu | Система контроля доступа |
| BMS | Building Management System | Система управления зданием |
| RTV i SAT | Radio-Telewizja i Satelita | Радио-ТВ и спутниковая система |
| SDG | System Detekcji Gazu | Система обнаружения газа |
| ROP | Ręczny Ostrzegacz Pożarowy | Ручной извещатель о пожаре |
| CSP | Centrala Sygnalizacji Pożarowej | Централь пожарной сигнализации |
| PZT | Punkt Złącza Technicznego | Точка технического соединения |
| PWP | Przeciwpożarowy Wyłącznik Prądu | Противопожарный выключатель тока |

## 2.3. Прочие сокращения

| Сокращение | Расшифровка |
|---|---|
| КП | Коммерческое предложение |
| CRUD | Create, Read, Update, Delete |
| API | Application Programming Interface |
| JWT | JSON Web Token |
| ЕИ | Единица измерения |
| Sn | Среднее напряжение |
| nn | Низкое напряжение |

---

# 3. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

## 3.1. Модуль приёма и регистрации запросов

### 3.1.1. Описание процесса

Запрос на расчёт создаётся, когда клиент обращается в компанию с просьбой рассчитать стоимость электромонтажных работ. Запрос является корневой сущностью, к которой привязываются формуляры, сметы и КП.

### 3.1.2. Поля формы запроса

| № | Поле | Тип данных | Обязательность | Валидация | Значение по умолчанию |
|---|---|---|---|---|---|
| 1 | Номер запроса | VARCHAR(20) | Да (авто) | Генерируется системой: ZAP-YYYY-NNNNN | — |
| 2 | Дата создания | DATETIME | Да (авто) | Текущая дата/время | NOW() |
| 3 | Наименование клиента | VARCHAR(255) | Да | Минимум 2 символа, максимум 255 | — |
| 4 | Контактное лицо | VARCHAR(255) | Да | Минимум 2 символа | — |
| 5 | Телефон | VARCHAR(20) | Да | Формат: +XX XXX XXX XXX | — |
| 6 | E-mail | VARCHAR(255) | Нет | Валидный e-mail (RFC 5322) | — |
| 7 | Название инвестиции | VARCHAR(500) | Да | Минимум 3 символа | — |
| 8 | Тип объекта | ENUM | Да | Одно из: «Промышленное здание», «Жилой дом», «Офисное здание» | — |
| 9 | Тип установки | ENUM[] | Да | Одно или оба из: «IE — Электроустановки», «IT — Телетехника» | — |
| 10 | Адрес объекта | VARCHAR(500) | Нет | — | — |
| 11 | Плановая дата ответа | DATE | Нет | Не ранее текущей даты | +7 дней |
| 12 | Примечания | TEXT | Нет | Максимум 5000 символов | — |
| 13 | Прикреплённые файлы | FILE[] | Нет | Допустимые форматы: PDF, XLSX, DOCX, DWG, JPG, PNG. Макс. размер одного файла: 50 МБ. Максимум 20 файлов. | — |
| 14 | Ответственный специалист | FK → users | Да | Выбор из справочника пользователей с ролью «Специалист» | Текущий пользователь |
| 15 | Источник запроса | ENUM | Нет | Одно из: «E-mail», «Телефон», «Личная встреча», «Тендер», «Другое» | — |

### 3.1.3. Статусы запроса и переходы

```
[Новый] → [В работе] → [Формуляр заполнен] → [Смета сформирована] → [Смета утверждена] → [КП отправлено] → [Закрыт]
                ↓                                        ↓                                          ↓
           [Отменён]                              [На доработке]                              [Отклонён клиентом]
```

| Текущий статус | Целевой статус | Условие перехода | Кто может |
|---|---|---|---|
| Новый | В работе | Специалист берёт запрос в работу | Специалист, Администратор |
| В работе | Формуляр заполнен | Формуляр прошёл валидацию на полноту | Специалист |
| Формуляр заполнен | Смета сформирована | Смета сгенерирована системой | Система (авто) |
| Смета сформирована | Смета утверждена | Руководитель утвердил смету | Руководитель |
| Смета сформирована | На доработке | Руководитель вернул на доработку | Руководитель |
| На доработке | Смета сформирована | Специалист внёс правки и переформировал | Специалист |
| Смета утверждена | КП отправлено | КП сгенерировано и отправлено | Специалист, Менеджер |
| КП отправлено | Закрыт | Клиент принял/отклонил | Менеджер |
| Любой (кроме Закрыт) | Отменён | Запрос отменён | Руководитель, Администратор |

### 3.1.4. Права доступа по ролям

| Действие | Администратор | Руководитель | Специалист | Менеджер |
|---|---|---|---|---|
| Создание запроса | ✓ | ✓ | ✓ | ✓ |
| Просмотр всех запросов | ✓ | ✓ | Только свои | Только свои |
| Редактирование запроса | ✓ | ✓ | Только свои, в статусе «Новый» или «В работе» | Нет |
| Удаление запроса | ✓ | Нет | Нет | Нет |
| Смена статуса | Все переходы | Утверждение, возврат, отмена | Взятие в работу, отметка о заполнении | Отправка КП, закрытие |

## 3.2. Модуль формуляра выполняемых работ

### 3.2.1. Типы формуляров

Система поддерживает 4 типа формуляров, определяемых комбинацией типа объекта и типа установки:

| Тип объекта | Тип установки | Код формуляра | Источник |
|---|---|---|---|
| Промышленное здание | IE — Электроустановки | FORM-PREM-IE | Файл «Przemysłowe formularz d.w.p.», лист IE |
| Промышленное здание | IT — Телетехника | FORM-PREM-IT | Файл «Przemysłowe formularz d.w.p.», лист IT |
| Жилой дом / Офис | IE — Электроустановки | FORM-MIESZK-IE | Файл «Mieszkaniówka i Biurowce», лист IE |
| Жилой дом / Офис | IT — Телетехника | FORM-MIESZK-IT | Файл «Mieszkaniówka i Biurowce», лист IT |

### 3.2.2. Структура формуляра

Каждый формуляр имеет две части:

**Часть A: Общие технические данные (шапка)**

Для промышленных зданий:

| Поле | Тип | Обязательность | Примечание |
|---|---|---|---|
| Площадь цеха (hala) | DECIMAL(10,2) | Да | В м² |
| Площадь офисных помещений | DECIMAL(10,2) | Нет | В м² |
| Тип наружных стен | VARCHAR(100) | Да | Например: кирпич, газобетон, сэндвич-панель |
| Тип внутренних стен | VARCHAR(100) | Да | Например: гипсокартон, кирпич, газобетон |
| Высота потолка цеха | DECIMAL(5,2) | Да | В метрах |
| Высота потолка офисных помещений | DECIMAL(5,2) | Нет | В метрах |
| Материал эксплуатационный | VARCHAR(255) | Нет | Описание расходных материалов |

Для жилых домов и офисов:

| Поле | Тип | Обязательность | Примечание |
|---|---|---|---|
| Количество квартир / площадь | VARCHAR(255) | Да | Например: «120 квартир, 8500 м²» |
| Тип наружных стен | VARCHAR(100) | Да | |
| Тип внутренних стен | VARCHAR(100) | Да | |
| Высота потолка | DECIMAL(5,2) | Да | В метрах |
| Материал эксплуатационный | VARCHAR(255) | Нет | |

**Часть B: Детальная матрица работ**

Матрица организована следующим образом:

- **Строки (ось Y):** Помещения и элементы установки, сгруппированные по зонам (например: Подземный гараж, Технические помещения, Лестничные клетки, Коридоры, Квартиры, Офисы, Склады, Цех, Крыша, Наружные территории).
- **Столбцы (ось X):** Виды работ, сгруппированные в категории.

**Категории работ (столбцов) для IE:**

1. **Подготовка (Przygotowanie):**
   - Штробление (Bruzdowanie)
   - Отделка штроб (Wykończenie bruzd)
   - Прокладка кабелей в потолке (Okablowanie w stropie)
   - Выполнение проходок (Wykonanie przewiertów)
   - Материал основной (Materiał Główny)
   - Материал мелкий (Materiał Drobny)
   - Монтаж кабельных трасс:
     - Кронштейн специализированный (Uchwyt dedykowany)
     - Кронштейн неспециализированный (Uchwyt niedydykowany)
     - Крепление лотков к стене (Mocowanie koryt do ściany)
     - Крепление лотков к потолку (Mocowanie koryt do sufitu)
     - Крепление подвесов к профлисту (Mocowanie wieszaków do blach prof.)
     - Шпилька (Szpilka)
     - Трос (Linka)
     - Швеллер (Ceownik)
     - Соединители специализированные (Łączniki dedykowane)
     - Соединители неспециализированные (Łączniki niededykowane)
     - Крышки (Pokrywy)
     - Защита острых кромок (Zabezpieczenie ostrych krawędzi)
     - Оцинковка резаных элементов (Ocynkowanie ciętych elementów)

2. **Прокладка кабелей (Okablowanie):**
   - Материал основной (Materiał Główny)
   - Материал мелкий (Materiał Drobny)
   - Подштукатурная (Podtynkowe)
   - Накладная (Natynkowe)
   - На кронштейнах (Uchwyt)
   - По кабельным трассам (Trasy kablowe)
   - В трубках/гофре (Rurki)
   - По стене (Po ścianie)
   - По потолку (Po suficie)
   - По полу (Po podłodze)

3. **Монтаж приёмников (Montaż odbiorników)** — для формуляра жилых домов дополнительно:
   - Материал основной и мелкий
   - Распределительный щит (натынкoвый / подштукатурный)
   - Сборка (Prefabrykacja)
   - Клеммы/Wago/Keystone/Patchcord
   - Монтаж коробок (Montaż puszki)
   - Крепление различными способами
   - Устройство/Оборудование (натынковое / подштукатурное)

4. **Запуск (Uruchomienie):**
   - Материал основной и мелкий
   - Подключение к сети
   - Программирование/Настройка
   - Измерения
   - Исполнительная документация

5. **Наружные работы (Prace zewnętrzne):**
   - Материал основной и мелкий
   - Выполнение траншеи
   - Подготовка основания
   - Засыпка
   - Восстановление покрытия
   - Восстановление газона
   - Газо-водонепроницаемая герметизация

6. **Оборудование/Инструмент (Sprzęt/Narzędzia):**
   - Строительные машины
   - Строительное оборудование

**Список помещений/элементов (строк) для формуляра IE жилых домов и офисов:**

Группа «Узиом»: Узиом, Узиом фундаментовый.

Группа «Подземный гараж»: Освещение основное, Освещение эвакуационное, Освещение аварийное, Выключатели, Розетки, Розетки силовые, Зарядные станции для электромобилей, Распределительные щиты, Питание греющих кабелей, Питание нагревателей, Вентиляция, Датчики движения/присутствия, Точки измерения, Точки заземления, Ворота, Парковочная платформа, Кабельные трассы, Огнестойкая заделка, Защита противопожарных проходов.

Группа «Кладовые»: Освещение основное, Освещение аварийное, Освещение эвакуационное, Выключатели, Точка заземления.

Группа «Технические помещения»: Освещение аварийное, Освещение эвакуационное, Освещение основное, Выключатели, Розетки, Розетки силовые, Распределительные щиты, Распределительный щит СН, Распределительный щит ГРН, Трансформаторная станция, Питание телетехнических шкафов, Датчики движения/присутствия, Вентиляция, Климатизация, Питание гидрофоров, Питание насосов, Питание тепловых узлов, Точки заземления, Питание помещения (WLZ), Питание управления, Шина выравнивания потенциалов, Питание от ZK, Кабельные трассы, Огнестойкая заделка.

Группа «Лестничные клетки»: Освещение основное, Освещение аварийное, Освещение эвакуационное, Выключатели, Розетки, Распределительные щиты, Датчики движения/присутствия, Вентиляция.

Группа «Лифт»: Освещение основное, Питание лифта.

Группа «Шахты»: Розетки сервисные, Распределительный щит, Точки заземления, Кабельные трассы.

Группа «Коридоры»: Освещение основное, Освещение аварийное, Освещение эвакуационное, Выключатели, Розетки, Датчики движения/присутствия, Вентиляция, Питание управления, Кабельные трассы.

Группа «Квартиры»: Освещение основное, Выключатели, Розетки, Точки управления, Кнопка звонка, Рольставни, Таблица квартирная (TM), Питание отопления, Точки заземления, Питание квартиры (WLZ), Питание телетехнической таблицы (TT), Питание управления, Вентиляция, Индукционная плита, Вывод питания.

Группа «Офисы»: Освещение основное, Освещение аварийное, Освещение эвакуационное, Выключатели, Розетки, Точки управления, Кнопка звонка, Рольставни, Распределительный щит, Питание отопления, Точки заземления, Питание офиса (WLZ), Питание телетехнического шкафа/RACK, Питание управления, Вентиляция, Индукционная плита, Вывод питания, Кабельные трассы.

Группа «Крыша»: Датчик сумерек, Климатизация, Вентиляция дахова, Питание нагревательных элементов, Распределительные щиты, Точки заземления, Кабельные трассы, Вывод крышный.

Группа «Молниезащита»: Вертикальные молниеприёмники, Горизонтальные молниеприёмники, Молниеприёмные стойки, Иглы, Коробка молниезащитного соединения.

Группа «Наружные территории (PZT)»: Настенные светильники, Осветительные столбы, Датчик сумерек, Фонари, Распределительные щиты, Кабельная канализация, Кабельный колодец, Точка управления, PWP, Зарядная станция, Шлагбаум/ворота, Фундамент под столбы.

**Аналогичные списки для IT-формуляров содержат:**

Группа «Подземный гараж»: SAP, SSO, DSO, SSWiN, CCTV, KD, Домофон, BMS, SDG.

Группа «Технические помещения»: SAP, SSO, DSO, SSWiN, CCTV, KD, Домофон, BMS, RTV и SAT, Шкаф RACK.

Группа «Лестничные клетки»: SAP, SSO, DSO, ROP, CSP, SSWiN, CCTV, KD, Домофон, BMS.

Группа «Лифт»: DSO, SAP, SSO, Интернет, BMS.

Группа «Шахты»: RTV и SAT, Оптоволокно, Интернет, Телефония.

И т.д. по всем зонам здания.

### 3.2.3. Логика условных элементов

- Если тип объекта = «Промышленное здание», формуляр содержит группу «Цех» (Hala) и «Склады» (Magazyny), но НЕ содержит группу «Квартиры».
- Если тип объекта = «Жилой дом», формуляр содержит группу «Квартиры» (Mieszkania), но НЕ содержит «Цех» и «Склады».
- Если тип объекта = «Офисное здание», формуляр содержит группу «Офисы» (Biura), но НЕ содержит «Квартиры», «Цех», «Склады».
- Столбцы категории «Монтаж кабельных трасс» для IT-формуляра НЕ содержат подкатегории «Крепление лотков к стене» и «Крепление лотков к потолку» — вместо этого есть «Крепление подвесов к профлисту», «Шпилька», «Трос».

### 3.2.4. Правила валидации формуляра

1. **Обязательность шапки:** Все обязательные поля части A должны быть заполнены.
2. **Минимальное заполнение матрицы:** Хотя бы одно пересечение в матрице должно быть отмечено.
3. **Логическая целостность:** Если отмечена работа «Прокладка кабелей подштукатурная» для помещения, должна быть отмечена и «Штробление» для того же помещения (предупреждение, не блокировка).
4. **Предупреждение о пропусках:** Если для помещения отмечены работы по монтажу оборудования, но не отмечена прокладка кабелей — система выдаёт предупреждение: «Для помещения [название] отмечен монтаж, но не отмечена прокладка кабелей. Проверьте корректность.»
5. **Обязательные пары:** Если отмечен «Материал основной», должен быть отмечен хотя бы один вид работ в той же категории. Иначе — предупреждение.

### 3.2.5. Сохранение формуляра

- Формуляр сохраняется автоматически каждые 30 секунд (автосохранение).
- При закрытии формуляра без сохранения — предупреждение: «Есть несохранённые изменения. Сохранить?»
- Каждое сохранение создаёт версию формуляра в истории изменений.
- Возможность вернуться к предыдущей версии формуляра.

## 3.3. Модуль автоматического формирования сметы

### 3.3.1. Алгоритм выбора работ

При нажатии кнопки «Сформировать смету» система выполняет следующие шаги:

1. Проверяет полноту заполнения формуляра (валидация по п. 3.2.4).
2. Перебирает все отмеченные ячейки формуляра.
3. Для каждой отмеченной ячейки определяет пару: (помещение/элемент, вид работ).
4. Ищет в таблице маппинга (mapping_rules) правило, соответствующее данной паре.
5. Если правило найдено — извлекает связанное шаблонное задание (template_task).
6. Из шаблонного задания формирует позицию сметы с предзаполненными данными.
7. Если правило НЕ найдено — создаёт позицию сметы с пустыми полями и пометкой «Требует ручного ввода».

### 3.3.2. Правила маппинга

Пример маппинга (формуляр FORM-MIESZK-IE):

| Помещение (строка) | Работа (столбец) | Шаблонное задание | Ед. изм. | Базовая цена работы | Материалы |
|---|---|---|---|---|---|
| Квартиры → Розетки | Штробление | Штробление под розетку | п.м. | 25 PLN | Нет |
| Квартиры → Розетки | Прокладка кабелей подштукатурная | Прокладка кабеля YDYp 3×2,5 | п.м. | 15 PLN | Кабель YDYp 3×2,5 мм² |
| Квартиры → Розетки | Монтаж коробки | Установка подрозетника | шт. | 12 PLN | Подрозетник Ø60 мм |
| Квартиры → Розетки | Устройство подштукатурное | Монтаж розетки | шт. | 35 PLN | Розетка Schneider Sedna |
| Технические помещения → Распределительный щит | Монтаж на стене | Установка распределительного щита | шт. | 450 PLN | Щит навесной 36 модулей |

### 3.3.3. Структура шаблона сметы

Позиция сметы содержит следующие поля:

| Поле | Описание | Заполнение |
|---|---|---|
| Номер позиции | Порядковый номер | Автоматически |
| Группа помещения | Название группы (например, «Квартиры») | Из формуляра |
| Элемент установки | Конкретный элемент (например, «Розетки») | Из формуляра |
| Задание | Описание работы | Из шаблонного задания |
| Материал | Наименование материала | Из шаблонного задания |
| Единица измерения | Ед. изм. | Из шаблонного задания |
| Количество | Объём работ | Пустое (ввод специалистом) |
| Цена ед. (работа) | Цена за единицу работы | Из прайс-листа |
| Стоимость (работа) | Количество × Цена ед. (работа) | Автоматически |
| Цена ед. (материал) | Цена за единицу материала | Из прайс-листа |
| Стоимость (материал) | Количество × Цена ед. (материал) | Автоматически |
| Итоговая стоимость | Стоимость (работа) + Стоимость (материал) | Автоматически |
| Конечный результат | Описание ожидаемого результата | Из шаблонного задания / из словаря |

## 3.4. Модуль редактирования и корректировки сметы

### 3.4.1. Возможности редактирования

Специалист может:
1. Изменять количество для каждой позиции.
2. Изменять цену единицы работы (с обоснованием — комментарий обязателен).
3. Изменять цену единицы материала (с обоснованием).
4. Изменять материал из справочника.
5. Добавлять новые позиции вручную (работы, не предусмотренные формуляром).
6. Удалять позиции (с подтверждением и комментарием).
7. Добавлять технику (аренда строительных машин и оборудования).
8. Группировать позиции по помещениям.
9. Перемещать позиции между группами.
10. Дублировать позиции.

### 3.4.2. Формулы расчёта

```
Стоимость_работы_позиции = Количество × Цена_единицы_работы

Стоимость_материала_позиции = Количество × Цена_единицы_материала

Итого_позиция = Стоимость_работы_позиции + Стоимость_материала_позиции

Итого_группа = Σ(Итого_позиция) по всем позициям группы

Итого_работы = Σ(Стоимость_работы_позиции) по всей смете

Итого_материалы = Σ(Стоимость_материала_позиции) по всей смете

Итого_техника = Σ(Стоимость_техники) по всей смете

Подытог_НЕТТО = Итого_работы + Итого_материалы + Итого_техника

НДС = Подытог_НЕТТО × Ставка_НДС (по умолчанию 23%)

ИТОГО_БРУТТО = Подытог_НЕТТО + НДС
```

### 3.4.3. Проверки и валидации

- Количество: число ≥ 0, до 2 знаков после запятой.
- Цена единицы: число ≥ 0, до 2 знаков после запятой.
- При изменении цены относительно справочника > 20% — предупреждение: «Цена отклоняется от справочной на [X]%. Подтвердите изменение.»
- При удалении позиции — подтверждение: «Вы уверены, что хотите удалить позицию [название]?»
- При сохранении сметы с нулевыми количествами — предупреждение: «В смете есть [N] позиций с нулевым количеством. Убрать их?»

## 3.5. Модуль формирования коммерческого предложения (КП)

### 3.5.1. Шаблон КП

КП формируется на основании утверждённой сметы и содержит:

1. Шапка: логотип компании, реквизиты компании, дата, номер КП.
2. Данные клиента: наименование, контактное лицо, адрес.
3. Название инвестиции.
4. Таблица работ (агрегированная): группы помещений, наименования работ, единицы измерения, количество, цены, стоимости.
5. Итоговая стоимость: нетто, НДС, брутто.
6. Условия (срок действия КП, условия оплаты, сроки выполнения).
7. Подписи.

### 3.5.2. Уровни детализации КП

- **Подробный:** Все позиции сметы без изменений.
- **Агрегированный:** Позиции сгруппированы по помещениям, показаны только итоги по группам.
- **Минимальный:** Только итоговая стоимость с разбивкой на работы и материалы.

### 3.5.3. Экспорт

- PDF (основной формат для клиента).
- Excel (для внутреннего использования).
- Word (для возможности редактирования перед отправкой).

### 3.5.4. Версионность

Каждая генерация КП создаёт новую версию: КП-2026-00001-v1, КП-2026-00001-v2 и т.д. Все версии сохраняются и доступны для просмотра.

## 3.6. Модуль справочников и настроек

### 3.6.1. Справочник видов работ

| Поле | Тип | Описание |
|---|---|---|
| ID | INT, PK | Уникальный идентификатор |
| Код | VARCHAR(50), UNIQUE | Код работы (например, BRUZD-001) |
| Наименование | VARCHAR(500) | Название работы |
| Категория | ENUM | Подготовка, Прокладка кабелей, Монтаж приёмников, Запуск, Наружные работы, Оборудование |
| Подкатегория | VARCHAR(200) | Например: Штробление, Монтаж трасс |
| Единица измерения | FK → units | Ссылка на справочник ЕИ |
| Описание задания | TEXT | Подробное описание работы |
| Ожидаемый результат | TEXT | Что должно быть выполнено (из словаря) |
| Нормо-часы на ед. | DECIMAL(8,4) | Трудоёмкость |
| Активна | BOOLEAN | Признак активности |
| Дата создания | DATETIME | Авто |
| Дата изменения | DATETIME | Авто |

### 3.6.2. Справочник материалов

| Поле | Тип | Описание |
|---|---|---|
| ID | INT, PK | Уникальный идентификатор |
| Код | VARCHAR(50), UNIQUE | Артикул |
| Наименование | VARCHAR(500) | Название материала |
| Категория | VARCHAR(200) | Например: Кабели, Лотки, Розетки, Щиты |
| Производитель | VARCHAR(200) | Производитель |
| Единица измерения | FK → units | Ссылка на справочник ЕИ |
| Тип | ENUM | Основной, Мелкий, Эксплуатационный |
| Описание | TEXT | Комментарий |
| Активен | BOOLEAN | |

### 3.6.3. Справочник техники

| Поле | Тип | Описание |
|---|---|---|
| ID | INT, PK | |
| Код | VARCHAR(50), UNIQUE | |
| Наименование | VARCHAR(500) | Например: экскаватор, бетономешалка |
| Категория | ENUM | Строительные машины, Строительное оборудование |
| Единица измерения | FK → units | Обычно: день, час |
| Описание | TEXT | |
| Активна | BOOLEAN | |

### 3.6.4. Справочник единиц измерения

Предустановленные значения: шт. (sztuka), п.м. (metr bieżący), м² (metr kwadratowy), м³ (metr sześcienny), кмпл. (komplet), день (dzień), час (godzina), кг (kilogram).

### 3.6.5. Прайс-листы

- Прайс-лист имеет период действия (дата начала — дата окончания).
- В один момент времени для каждого вида работ/материала/техники действует только один прайс.
- При создании сметы система берёт цену из прайс-листа, действующего на дату создания сметы.
- Изменение прайс-листа не влияет на ранее созданные сметы.

### 3.6.6. Шаблонные задания

Шаблонное задание — это предконфигурированный набор:
- Вид работы (из справочника).
- Список материалов с коэффициентами (например: на 1 розетку — 1 подрозетник + 5 п.м. кабеля + 0,1 кг гипса).
- Список техники (если требуется).
- Нормо-часы.
- Ожидаемый результат.

### 3.6.7. Настройка маппинга

Администратор или руководитель может настраивать правила маппинга:
- Выбрать тип формуляра.
- Выбрать строку формуляра (помещение/элемент).
- Выбрать столбец формуляра (вид работ).
- Привязать шаблонное задание.
- Указать коэффициент умножения (если нужно).

## 3.7. Модуль управления пользователями и правами доступа

### 3.7.1. Роли

| Роль | Описание |
|---|---|
| Администратор | Полный доступ ко всем модулям. Управление пользователями, справочниками, настройками. |
| Руководитель | Просмотр всех запросов и смет. Утверждение/возврат смет. Управление справочниками. |
| Специалист по сметам | Создание запросов, заполнение формуляров, формирование и редактирование смет. Работа только со своими запросами. |
| Менеджер по продажам | Создание запросов, просмотр КП, отправка КП клиентам. |
| Наблюдатель | Только просмотр (read-only). |

### 3.7.2. Матрица прав доступа

| Модуль / Действие | Администратор | Руководитель | Специалист | Менеджер | Наблюдатель |
|---|---|---|---|---|---|
| Запросы: создание | ✓ | ✓ | ✓ | ✓ | — |
| Запросы: просмотр всех | ✓ | ✓ | — | — | ✓ |
| Запросы: просмотр своих | ✓ | ✓ | ✓ | ✓ | — |
| Запросы: редактирование | ✓ | ✓ | Свои | — | — |
| Запросы: удаление | ✓ | — | — | — | — |
| Формуляр: заполнение | ✓ | ✓ | ✓ | — | — |
| Смета: формирование | ✓ | ✓ | ✓ | — | — |
| Смета: редактирование | ✓ | ✓ | ✓ | — | — |
| Смета: утверждение | ✓ | ✓ | — | — | — |
| КП: генерация | ✓ | ✓ | ✓ | ✓ | — |
| КП: отправка | ✓ | ✓ | — | ✓ | — |
| Справочники: просмотр | ✓ | ✓ | ✓ | ✓ | ✓ |
| Справочники: редактирование | ✓ | ✓ | — | — | — |
| Маппинг: настройка | ✓ | ✓ | — | — | — |
| Прайс-листы: управление | ✓ | ✓ | — | — | — |
| Пользователи: управление | ✓ | — | — | — | — |
| Отчёты: просмотр | ✓ | ✓ | Свои | Свои | ✓ |

## 3.8. Модуль отчётности и аналитики

### 3.8.1. Отчёт по запросам

- Период (дата от — дата до).
- Фильтры: статус, тип объекта, ответственный специалист.
- Показатели: количество запросов, среднее время обработки, % просроченных.

### 3.8.2. Отчёт по сметам

- Распределение смет по статусам.
- Средняя стоимость сметы по типам объектов.
- Топ-10 самых дорогих позиций.
- Частота использования позиций.

### 3.8.3. Отчёт по КП

- Количество отправленных КП.
- Конверсия КП → контракт (если отслеживается).
- Средняя стоимость КП.

### 3.8.4. Аналитика ошибок

- Позиции, которые чаще всего добавляются вручную (кандидаты на добавление в маппинг).
- Позиции, которые чаще всего удаляются (кандидаты на исключение из маппинга).
- Позиции с наибольшим отклонением цены от справочной.

---

# 4. ОПИСАНИЕ БИЗНЕС-ПРОЦЕССОВ

## 4.1. БП-01: Создание и обработка запроса

```
НАЧАЛО
  │
  ▼
[1] Менеджер/Специалист создаёт запрос
  │  → Заполняет форму (п.3.1.2)
  │  → Система валидирует данные
  │  → Система присваивает номер ZAP-YYYY-NNNNN
  │  → Статус = «Новый»
  │  → Система сохраняет в БД (таблица requests)
  │  → Система отправляет уведомление ответственному
  │
  ▼
[2] Специалист открывает запрос
  │  → Нажимает «Взять в работу»
  │  → Статус = «В работе»
  │
  ▼
[3] Специалист создаёт формуляр
  │  → Система определяет тип формуляра по типу объекта и установки
  │  → Загружает шаблон матрицы
  │  → Специалист заполняет шапку и матрицу
  │
  ▼
[4] Проверка полноты? ─── НЕТ → [3] Доработка
  │
  ДА
  │
  ▼
[5] Специалист нажимает «Сформировать смету»
  │  → Система выполняет маппинг (п.3.3.1)
  │  → Формирует позиции сметы
  │  → Статус = «Смета сформирована»
  │
  ▼
[6] Специалист редактирует смету
  │  → Вводит количества
  │  → Корректирует цены/материалы
  │  → Добавляет/удаляет позиции
  │
  ▼
[7] Специалист отправляет на утверждение
  │  → Система уведомляет руководителя
  │
  ▼
[8] Руководитель проверяет ─── ОТКЛОНЕНО → [6] Доработка
  │                               (статус = «На доработке»)
  УТВЕРЖДЕНО
  │
  ▼
[9] Статус = «Смета утверждена»
  │  → Формирование КП
  │
  ▼
[10] Менеджер/Специалист генерирует КП
  │   → Выбирает уровень детализации
  │   → Выбирает формат экспорта
  │   → Система создаёт документ КП
  │   → Статус = «КП отправлено»
  │
  ▼
[11] Менеджер отправляет КП клиенту
  │
  ▼
[12] Получен ответ? ─── НЕТ → Ожидание
  │
  ДА
  │
  ▼
[13] Закрытие запроса
  │   → Статус = «Закрыт»
  │   → Комментарий (принято/отклонено клиентом)
  │
  ▼
КОНЕЦ
```

## 4.2. БП-02: Заполнение формуляра

**Действия пользователя:**

1. Пользователь открывает запрос → нажимает «Заполнить формуляр».
2. Система отображает шапку формуляра. Пользователь заполняет общие технические данные.
3. Система отображает матрицу. По вертикали — дерево помещений (с возможностью сворачивания групп). По горизонтали — столбцы работ с группировкой по категориям.
4. Пользователь кликает на ячейки для установки/снятия отметки «X».
5. При наведении на заголовок столбца — всплывающая подсказка с описанием работы (из словаря).
6. Кнопка «Проверить полноту» — запуск валидации.
7. Кнопка «Сохранить» — явное сохранение.
8. Кнопка «Сформировать смету» — переход к п. 3.3.

**Действия системы:**

- При каждом клике — мгновенное сохранение изменённой ячейки (debounce 500 мс).
- Автосохранение каждые 30 секунд.
- Подсветка строк, где нет ни одной отметки (серый фон).
- Подсветка строк с потенциальными пропусками (жёлтый фон) — по правилам п. 3.2.4.
- Счётчик: «Заполнено X из Y возможных пересечений».

## 4.3. БП-03: Формирование и редактирование сметы

**Пошаговое описание:**

1. Специалист нажимает «Сформировать смету» на экране формуляра.
2. Система запускает алгоритм маппинга:
   - a) Получает все отмеченные ячейки формуляра → массив пар (room_id, work_type_id).
   - b) Для каждой пары ищет в таблице mapping_rules запись с совпадающими form_type, room_code, work_type_code.
   - c) Если запись найдена → берёт template_task_id.
   - d) Из template_task получает: наименование, ед. изм., нормо-часы, ожидаемый результат.
   - e) Из template_task_materials получает список материалов и коэффициенты.
   - f) Из price_lists берёт актуальную цену работы и материалов.
   - g) Создаёт запись в estimate_items.
3. Система отображает смету в табличном виде.
4. Специалист заполняет столбец «Количество».
5. При вводе количества → пересчёт стоимостей (работа, материал, итого) в реальном времени.
6. Специалист может:
   - Нажать «+» для добавления новой позиции → выбор из справочника работ → указание количества.
   - Нажать «×» для удаления → подтверждение → удаление.
   - Кликнуть на ячейку материала → выбор альтернативного материала из справочника.
   - Добавить технику: кнопка «Добавить технику» → выбор из справочника → указание количества и дней/часов.
7. Специалист нажимает «Сохранить смету».
8. Система сохраняет все позиции, пересчитывает итоги.

**Пример:**

Специалист отметил в формуляре: Квартиры → Розетки × Штробление. Система находит маппинг:
- Шаблонное задание: «Штробление под розетку».
- Единица измерения: п.м.
- Цена из прайс-листа: 25 PLN/п.м.
- Материалы: нет (штробление не требует материала).
- Конечный результат: «Штробы выполнены ровно, по размерам и очищены».

Специалист вводит количество: 150 п.м.
Система рассчитывает: Стоимость работы = 150 × 25 = 3 750 PLN.

---

# 5. ТРЕБОВАНИЯ К ИНТЕРФЕЙСУ ПОЛЬЗОВАТЕЛЯ

## 5.1. Общие принципы

- Язык интерфейса: польский (основной), с возможностью переключения на русский и английский.
- Адаптивная вёрстка для экранов от 1280px.
- Цветовая схема: нейтральная (белый/серый фон, синие акценты).
- Шрифт: Inter или аналогичный sans-serif.
- Навигация: левая боковая панель с иконками и текстовыми подписями.

## 5.2. Экран: Дашборд (главная страница)

**Назначение:** Обзор текущей работы, быстрый доступ к ключевым действиям.

**Элементы:**

- **Карточки статистики (верхняя строка):**
  - «Новых запросов» — число, клик → фильтрованный список запросов.
  - «В работе» — число.
  - «Ожидают утверждения» — число (для руководителя).
  - «КП отправлено» — число за текущий месяц.

- **Таблица «Мои запросы» (центральная часть):**
  - Столбцы: №, Клиент, Инвестиция, Тип, Статус, Дата создания, Плановая дата.
  - Фильтры: статус, период.
  - Сортировка: по любому столбцу.
  - Клик по строке → переход к экрану запроса.

- **Кнопка «+ Новый запрос»** — правый верхний угол.

**Навигация:** Доступен всегда через боковую панель. Стартовый экран при входе.

## 5.3. Экран: Список запросов

**Назначение:** Просмотр всех запросов с фильтрацией и поиском.

**Элементы:**

- **Строка поиска:** Поиск по номеру запроса, клиенту, названию инвестиции.
- **Фильтры:**
  - Статус (мультивыбор чекбоксами).
  - Тип объекта (мультивыбор).
  - Тип установки (мультивыбор).
  - Ответственный (выпадающий список).
  - Период создания (от — до).
- **Таблица запросов:**
  - Столбцы: №, Клиент, Инвестиция, Тип объекта, Тип установки, Статус, Ответственный, Дата создания, Плановая дата.
  - Цветная индикация: просроченные — красный фон, близкие к сроку — жёлтый.
  - Пагинация: 20/50/100 записей на странице.
- **Кнопка «+ Новый запрос»**.
- **Кнопка «Экспорт в Excel»** — экспорт списка с фильтрами.

## 5.4. Экран: Карточка запроса

**Назначение:** Просмотр и редактирование одного запроса, навигация к формуляру/смете/КП.

**Элементы:**

- **Заголовок:** Номер запроса, текущий статус (цветной бейдж).
- **Панель действий:**
  - «Взять в работу» (если статус = Новый).
  - «Заполнить формуляр» (если статус = В работе).
  - «Сформировать смету» (если формуляр заполнен).
  - «Отправить на утверждение».
  - «Утвердить» / «Вернуть на доработку» (для руководителя).
  - «Сформировать КП».
  - «Отменить запрос».
- **Вкладки:**
  - **Основная информация:** Форма с полями запроса (п. 3.1.2).
  - **Формуляр:** Встроенная матрица формуляра или ссылка на экран формуляра.
  - **Смета:** Таблица позиций сметы или ссылка на экран сметы.
  - **КП:** Список версий КП с кнопками скачивания.
  - **Файлы:** Прикреплённые документы.
  - **История:** Лог всех изменений запроса (кто, когда, что изменил).

## 5.5. Экран: Формуляр работ

**Назначение:** Электронная матрица для отметки объёма работ.

**Элементы:**

- **Шапка формуляра:** Поля общих технических данных (п. 3.2.2, Часть A). Кнопка «Свернуть/Развернуть шапку».

- **Панель инструментов:**
  - Кнопка «Сохранить».
  - Кнопка «Проверить полноту».
  - Кнопка «Сформировать смету».
  - Кнопка «Очистить всё» (с подтверждением).
  - Переключатель: «IE / IT» (если оба типа выбраны).
  - Индикатор: «Автосохранение: [время последнего сохранения]».

- **Матрица:**
  - Левый столбец (фиксированный): Дерево помещений/элементов. Группы можно сворачивать/разворачивать (аккордеон).
  - Верхняя строка (фиксированная): Категории работ → подкатегории → конкретные работы. Трёхуровневая шапка.
  - Ячейки: Кликабельные. Пустая ячейка — нет работы. Ячейка с «X» (зелёная) — работа отмечена.
  - Всплывающая подсказка (tooltip) при наведении на заголовок столбца: описание работы из словаря.
  - Всплывающая подсказка при наведении на заголовок строки: описание помещения/элемента.

- **Индикаторы:**
  - Строка с пропусками — жёлтый фон.
  - Строка без отметок — серый фон.
  - Счётчик внизу: «Отмечено: [N] позиций».

**Поведение:**
- Клик по пустой ячейке → ячейка становится отмеченной (зелёная с «X»).
- Повторный клик по отмеченной ячейке → отметка снимается.
- Горизонтальный и вертикальный скроллинг с фиксированными заголовками.
- Масштабирование (Ctrl+колесо) для удобства навигации.

## 5.6. Экран: Смета

**Назначение:** Просмотр, редактирование позиций сметы, расчёт стоимости.

**Элементы:**

- **Заголовок:** Название инвестиции, номер запроса, статус сметы.

- **Панель инструментов:**
  - Кнопка «+ Добавить позицию».
  - Кнопка «+ Добавить технику».
  - Кнопка «Сохранить».
  - Кнопка «Отправить на утверждение».
  - Кнопка «Экспорт в Excel».
  - Кнопка «Печать».
  - Кнопка «Переформировать из формуляра» (пересоздание сметы — с предупреждением о потере ручных правок).

- **Таблица позиций сметы:**
  - Столбцы: №, Группа, Элемент, Задание, Материал, ЕИ, Количество (editable), Цена ед. работы (editable), Стоимость работы (авто), Цена ед. материала (editable), Стоимость материала (авто), Итого (авто), Конечный результат.
  - Группировка: Строки сгруппированы по помещениям. Подитоги по каждой группе.
  - Строки с пустым количеством подсвечены жёлтым.
  - Строки, добавленные вручную — помечены иконкой «✏».
  - Для каждой строки: кнопки «Редактировать», «Дублировать», «Удалить».

- **Блок итогов (фиксированный внизу):**
  - Итого работы: [сумма].
  - Итого материалы: [сумма].
  - Итого техника: [сумма].
  - Подитог НЕТТО: [сумма].
  - НДС (23%): [сумма].
  - ИТОГО БРУТТО: [сумма].

- **Секция «Техника» (под таблицей работ):**
  - Отдельная таблица: Наименование, ЕИ, Количество, Цена ед., Стоимость.

## 5.7. Экран: Управление справочниками

**Назначение:** CRUD-операции для справочников работ, материалов, техники.

**Элементы (одинаковые для всех справочников):**

- **Вкладки:** Виды работ | Материалы | Техника | Единицы измерения | Прайс-листы | Шаблонные задания | Маппинг.
- **Для каждой вкладки:**
  - Строка поиска.
  - Фильтры (по категории, статусу).
  - Таблица записей.
  - Кнопки: «+ Добавить», «Редактировать», «Деактивировать» (мягкое удаление).
  - Пагинация.

## 5.8. Экран: Настройка маппинга

**Назначение:** Визуальная настройка правил соответствия формуляр → шаблонное задание.

**Элементы:**

- **Фильтр типа формуляра:** Выпадающий список (4 типа).
- **Таблица маппинга:**
  - Столбцы: Помещение/Элемент, Вид работ, Шаблонное задание (привязанное), Коэффициент, Действия.
  - Для ячеек без привязки — кнопка «Привязать».
  - Клик «Привязать» → модальное окно с поиском по шаблонным заданиям.
- **Индикатор покрытия:** «Привязано X из Y возможных пересечений (Z%)».

---

# 6. МОДЕЛЬ ДАННЫХ

## 6.1. Перечень таблиц

### Таблица: users

**Назначение:** Хранение данных пользователей системы.

| Поле | Тип | Размер | NOT NULL | По умолчанию | Ограничения |
|---|---|---|---|---|---|
| id | SERIAL | — | ✓ | auto | PK |
| email | VARCHAR | 255 | ✓ | — | UNIQUE |
| password_hash | VARCHAR | 255 | ✓ | — | — |
| first_name | VARCHAR | 100 | ✓ | — | — |
| last_name | VARCHAR | 100 | ✓ | — | — |
| role_id | INT | — | ✓ | — | FK → roles.id |
| is_active | BOOLEAN | — | ✓ | TRUE | — |
| phone | VARCHAR | 20 | — | NULL | — |
| created_at | TIMESTAMP | — | ✓ | NOW() | — |
| updated_at | TIMESTAMP | — | ✓ | NOW() | — |
| last_login | TIMESTAMP | — | — | NULL | — |

Индексы: idx_users_email (UNIQUE), idx_users_role_id.

---

### Таблица: roles

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| name | VARCHAR(50) | ✓ | UNIQUE |
| display_name | VARCHAR(100) | ✓ | — |
| description | TEXT | — | — |

Предустановленные данные: (1, 'admin', 'Администратор'), (2, 'manager', 'Руководитель'), (3, 'specialist', 'Специалист'), (4, 'sales', 'Менеджер по продажам'), (5, 'observer', 'Наблюдатель').

---

### Таблица: requests

**Назначение:** Запросы на расчёт.

| Поле | Тип | Размер | NOT NULL | По умолчанию | Ограничения |
|---|---|---|---|---|---|
| id | SERIAL | — | ✓ | auto | PK |
| request_number | VARCHAR | 20 | ✓ | — | UNIQUE |
| status | VARCHAR | 30 | ✓ | 'new' | CHECK (IN('new','in_progress','form_filled','estimate_generated','estimate_approved','estimate_revision','kp_sent','closed','cancelled')) |
| client_name | VARCHAR | 255 | ✓ | — | — |
| contact_person | VARCHAR | 255 | ✓ | — | — |
| phone | VARCHAR | 20 | ✓ | — | — |
| email | VARCHAR | 255 | — | NULL | — |
| investment_name | VARCHAR | 500 | ✓ | — | — |
| object_type | VARCHAR | 30 | ✓ | — | CHECK (IN('industrial','residential','office')) |
| installation_types | VARCHAR | 10 | ✓ | — | CHECK (IN('IE','IT','IE,IT')) |
| address | VARCHAR | 500 | — | NULL | — |
| planned_response_date | DATE | — | — | NULL | — |
| notes | TEXT | — | — | NULL | — |
| request_source | VARCHAR | 30 | — | NULL | — |
| assigned_user_id | INT | — | ✓ | — | FK → users.id |
| created_by | INT | — | ✓ | — | FK → users.id |
| created_at | TIMESTAMP | — | ✓ | NOW() | — |
| updated_at | TIMESTAMP | — | ✓ | NOW() | — |

Индексы: idx_requests_number (UNIQUE), idx_requests_status, idx_requests_assigned_user, idx_requests_created_at.

---

### Таблица: request_files

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| request_id | INT | ✓ | FK → requests.id ON DELETE CASCADE |
| file_name | VARCHAR(255) | ✓ | — |
| file_path | VARCHAR(500) | ✓ | — |
| file_size | BIGINT | ✓ | — |
| mime_type | VARCHAR(100) | ✓ | — |
| uploaded_by | INT | ✓ | FK → users.id |
| uploaded_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: forms

**Назначение:** Формуляры выполняемых работ.

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| request_id | INT | ✓ | FK → requests.id ON DELETE CASCADE |
| form_type | VARCHAR(20) | ✓ | CHECK (IN('PREM-IE','PREM-IT','MIESZK-IE','MIESZK-IT')) |
| version | INT | ✓ | DEFAULT 1 |
| is_current | BOOLEAN | ✓ | DEFAULT TRUE |
| status | VARCHAR(20) | ✓ | DEFAULT 'draft', CHECK (IN('draft','completed','archived')) |
| created_by | INT | ✓ | FK → users.id |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

Индексы: idx_forms_request_id, idx_forms_type.

---

### Таблица: form_general_data

**Назначение:** Общие технические данные (шапка формуляра).

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| form_id | INT | ✓ | FK → forms.id ON DELETE CASCADE, UNIQUE |
| hall_area | DECIMAL(10,2) | — | — |
| office_area | DECIMAL(10,2) | — | — |
| apartments_count | VARCHAR(255) | — | — |
| ext_wall_type | VARCHAR(100) | — | — |
| int_wall_type | VARCHAR(100) | — | — |
| hall_ceiling_height | DECIMAL(5,2) | — | — |
| office_ceiling_height | DECIMAL(5,2) | — | — |
| ceiling_height | DECIMAL(5,2) | — | — |
| consumable_material | VARCHAR(255) | — | — |

---

### Таблица: form_answers

**Назначение:** Отметки в матрице формуляра (каждая отметка — одна запись).

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| form_id | INT | ✓ | FK → forms.id ON DELETE CASCADE |
| room_code | VARCHAR(100) | ✓ | — |
| room_group | VARCHAR(100) | ✓ | — |
| work_type_code | VARCHAR(100) | ✓ | — |
| work_category | VARCHAR(100) | ✓ | — |
| is_marked | BOOLEAN | ✓ | DEFAULT TRUE |
| created_at | TIMESTAMP | ✓ | NOW() |

Индексы: idx_form_answers_form_id, UNIQUE (form_id, room_code, work_type_code).

---

### Таблица: estimates

**Назначение:** Сметы.

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| request_id | INT | ✓ | FK → requests.id |
| form_id | INT | ✓ | FK → forms.id |
| estimate_number | VARCHAR(30) | ✓ | UNIQUE |
| version | INT | ✓ | DEFAULT 1 |
| status | VARCHAR(20) | ✓ | DEFAULT 'draft' |
| vat_rate | DECIMAL(5,2) | ✓ | DEFAULT 23.00 |
| total_works | DECIMAL(15,2) | ✓ | DEFAULT 0 |
| total_materials | DECIMAL(15,2) | ✓ | DEFAULT 0 |
| total_equipment | DECIMAL(15,2) | ✓ | DEFAULT 0 |
| subtotal_net | DECIMAL(15,2) | ✓ | DEFAULT 0 |
| vat_amount | DECIMAL(15,2) | ✓ | DEFAULT 0 |
| total_gross | DECIMAL(15,2) | ✓ | DEFAULT 0 |
| approved_by | INT | — | FK → users.id |
| approved_at | TIMESTAMP | — | — |
| created_by | INT | ✓ | FK → users.id |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: estimate_items

**Назначение:** Позиции сметы.

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| estimate_id | INT | ✓ | FK → estimates.id ON DELETE CASCADE |
| position_number | INT | ✓ | — |
| room_group | VARCHAR(200) | ✓ | — |
| installation_element | VARCHAR(200) | ✓ | — |
| task_description | VARCHAR(500) | ✓ | — |
| material_name | VARCHAR(500) | — | — |
| unit_id | INT | ✓ | FK → units.id |
| quantity | DECIMAL(10,2) | — | DEFAULT 0 |
| unit_price_work | DECIMAL(10,2) | — | DEFAULT 0 |
| total_work | DECIMAL(15,2) | — | DEFAULT 0 |
| unit_price_material | DECIMAL(10,2) | — | DEFAULT 0 |
| total_material | DECIMAL(15,2) | — | DEFAULT 0 |
| total_item | DECIMAL(15,2) | — | DEFAULT 0 |
| expected_result | TEXT | — | — |
| source | VARCHAR(20) | ✓ | DEFAULT 'auto', CHECK (IN('auto','manual')) |
| template_task_id | INT | — | FK → template_tasks.id |
| mapping_rule_id | INT | — | FK → mapping_rules.id |
| is_deleted | BOOLEAN | ✓ | DEFAULT FALSE |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

Индексы: idx_estimate_items_estimate_id, idx_estimate_items_position.

---

### Таблица: estimate_equipment

**Назначение:** Техника в смете.

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| estimate_id | INT | ✓ | FK → estimates.id ON DELETE CASCADE |
| equipment_id | INT | ✓ | FK → equipment.id |
| unit_id | INT | ✓ | FK → units.id |
| quantity | DECIMAL(10,2) | ✓ | — |
| unit_price | DECIMAL(10,2) | ✓ | — |
| total | DECIMAL(15,2) | ✓ | — |

---

### Таблица: commercial_proposals

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| request_id | INT | ✓ | FK → requests.id |
| estimate_id | INT | ✓ | FK → estimates.id |
| kp_number | VARCHAR(30) | ✓ | — |
| version | INT | ✓ | DEFAULT 1 |
| detail_level | VARCHAR(20) | ✓ | CHECK (IN('detailed','aggregated','minimal')) |
| file_path_pdf | VARCHAR(500) | — | — |
| file_path_xlsx | VARCHAR(500) | — | — |
| file_path_docx | VARCHAR(500) | — | — |
| validity_days | INT | ✓ | DEFAULT 30 |
| payment_terms | TEXT | — | — |
| execution_terms | TEXT | — | — |
| created_by | INT | ✓ | FK → users.id |
| created_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: work_types (Справочник видов работ)

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| code | VARCHAR(50) | ✓ | UNIQUE |
| name | VARCHAR(500) | ✓ | — |
| category | VARCHAR(100) | ✓ | — |
| subcategory | VARCHAR(200) | — | — |
| unit_id | INT | ✓ | FK → units.id |
| task_description | TEXT | — | — |
| expected_result | TEXT | — | — |
| labor_hours_per_unit | DECIMAL(8,4) | — | — |
| is_active | BOOLEAN | ✓ | DEFAULT TRUE |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: materials (Справочник материалов)

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| code | VARCHAR(50) | ✓ | UNIQUE |
| name | VARCHAR(500) | ✓ | — |
| category | VARCHAR(200) | — | — |
| manufacturer | VARCHAR(200) | — | — |
| unit_id | INT | ✓ | FK → units.id |
| material_type | VARCHAR(20) | ✓ | CHECK (IN('main','minor','consumable')) |
| description | TEXT | — | — |
| is_active | BOOLEAN | ✓ | DEFAULT TRUE |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: equipment (Справочник техники)

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| code | VARCHAR(50) | ✓ | UNIQUE |
| name | VARCHAR(500) | ✓ | — |
| category | VARCHAR(50) | ✓ | CHECK (IN('machines','tools')) |
| unit_id | INT | ✓ | FK → units.id |
| description | TEXT | — | — |
| is_active | BOOLEAN | ✓ | DEFAULT TRUE |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: units (Единицы измерения)

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| code | VARCHAR(10) | ✓ | UNIQUE |
| name | VARCHAR(50) | ✓ | — |
| name_pl | VARCHAR(50) | ✓ | — |

---

### Таблица: template_tasks (Шаблонные задания)

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| code | VARCHAR(50) | ✓ | UNIQUE |
| name | VARCHAR(500) | ✓ | — |
| work_type_id | INT | ✓ | FK → work_types.id |
| unit_id | INT | ✓ | FK → units.id |
| labor_hours | DECIMAL(8,4) | — | — |
| expected_result | TEXT | — | — |
| is_active | BOOLEAN | ✓ | DEFAULT TRUE |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: template_task_materials

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| template_task_id | INT | ✓ | FK → template_tasks.id ON DELETE CASCADE |
| material_id | INT | ✓ | FK → materials.id |
| quantity_coefficient | DECIMAL(8,4) | ✓ | DEFAULT 1.0 |

---

### Таблица: template_task_equipment

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| template_task_id | INT | ✓ | FK → template_tasks.id ON DELETE CASCADE |
| equipment_id | INT | ✓ | FK → equipment.id |
| quantity_coefficient | DECIMAL(8,4) | ✓ | DEFAULT 1.0 |

---

### Таблица: price_lists

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| name | VARCHAR(200) | ✓ | — |
| valid_from | DATE | ✓ | — |
| valid_to | DATE | — | — |
| is_active | BOOLEAN | ✓ | DEFAULT TRUE |
| created_by | INT | ✓ | FK → users.id |
| created_at | TIMESTAMP | ✓ | NOW() |

---

### Таблица: price_list_items

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| price_list_id | INT | ✓ | FK → price_lists.id ON DELETE CASCADE |
| item_type | VARCHAR(20) | ✓ | CHECK (IN('work','material','equipment')) |
| item_id | INT | ✓ | — |
| unit_price | DECIMAL(10,2) | ✓ | CHECK (>= 0) |

UNIQUE (price_list_id, item_type, item_id).

---

### Таблица: mapping_rules

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | SERIAL | ✓ | PK |
| form_type | VARCHAR(20) | ✓ | — |
| room_code | VARCHAR(100) | ✓ | — |
| room_group | VARCHAR(100) | ✓ | — |
| work_type_code | VARCHAR(100) | ✓ | — |
| work_category | VARCHAR(100) | ✓ | — |
| template_task_id | INT | ✓ | FK → template_tasks.id |
| coefficient | DECIMAL(8,4) | ✓ | DEFAULT 1.0 |
| is_active | BOOLEAN | ✓ | DEFAULT TRUE |
| created_at | TIMESTAMP | ✓ | NOW() |
| updated_at | TIMESTAMP | ✓ | NOW() |

UNIQUE (form_type, room_code, work_type_code).

---

### Таблица: audit_log (История изменений)

| Поле | Тип | NOT NULL | Ограничения |
|---|---|---|---|
| id | BIGSERIAL | ✓ | PK |
| entity_type | VARCHAR(50) | ✓ | — |
| entity_id | INT | ✓ | — |
| action | VARCHAR(20) | ✓ | CHECK (IN('create','update','delete','status_change')) |
| old_values | JSONB | — | — |
| new_values | JSONB | — | — |
| user_id | INT | ✓ | FK → users.id |
| ip_address | VARCHAR(45) | — | — |
| created_at | TIMESTAMP | ✓ | NOW() |

Индексы: idx_audit_entity (entity_type, entity_id), idx_audit_created_at.

---

## 6.2. ER-диаграмма (текстовое описание связей)

```
users (1) ──── (N) requests           [assigned_user_id, created_by]
users (1) ──── (N) roles              [role_id]
requests (1) ── (N) request_files     [request_id]
requests (1) ── (N) forms             [request_id]
requests (1) ── (N) estimates         [request_id]
requests (1) ── (N) commercial_proposals [request_id]
forms (1) ──── (1) form_general_data  [form_id]
forms (1) ──── (N) form_answers       [form_id]
forms (1) ──── (N) estimates          [form_id]
estimates (1) ─ (N) estimate_items    [estimate_id]
estimates (1) ─ (N) estimate_equipment [estimate_id]
estimates (1) ─ (N) commercial_proposals [estimate_id]
work_types (1) ─ (N) template_tasks   [work_type_id]
template_tasks (1) ─ (N) template_task_materials [template_task_id]
template_tasks (1) ─ (N) template_task_equipment [template_task_id]
template_tasks (1) ─ (N) mapping_rules [template_task_id]
materials (1) ─── (N) template_task_materials [material_id]
equipment (1) ─── (N) template_task_equipment [equipment_id]
equipment (1) ─── (N) estimate_equipment [equipment_id]
units (1) ─────── (N) work_types, materials, equipment, template_tasks, estimate_items [unit_id]
price_lists (1) ─ (N) price_list_items [price_list_id]
users (1) ─────── (N) audit_log       [user_id]
```

---

# 7. API-СПЕЦИФИКАЦИЯ

Базовый URL: `https://api.elektrosmeta.pl/v1`

Аутентификация: Bearer Token (JWT) в заголовке `Authorization: Bearer <token>`.

## 7.1. Аутентификация

### POST /auth/login

**Назначение:** Вход в систему.

**Request Body:**
```json
{
  "email": "jan.kowalski@firma.pl",
  "password": "SecurePass123"
}
```

**Response 200:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "dGhpcyBpcyBhIHJlZnJlc2g...",
  "user": {
    "id": 1,
    "email": "jan.kowalski@firma.pl",
    "first_name": "Jan",
    "last_name": "Kowalski",
    "role": "specialist"
  },
  "expires_in": 3600
}
```

**Response 401:**
```json
{
  "error": "INVALID_CREDENTIALS",
  "message": "Nieprawidłowy email lub hasło"
}
```

### POST /auth/refresh

**Назначение:** Обновление токена.

**Request Body:**
```json
{
  "refresh_token": "dGhpcyBpcyBhIHJlZnJlc2g..."
}
```

**Response 200:** аналогично login.

## 7.2. Запросы (Requests)

### GET /requests

**Назначение:** Список запросов с фильтрацией и пагинацией.

**Query Parameters:**
- `page` (int, default 1)
- `per_page` (int, default 20, max 100)
- `status` (string, comma-separated)
- `object_type` (string)
- `assigned_user_id` (int)
- `date_from` (date, YYYY-MM-DD)
- `date_to` (date, YYYY-MM-DD)
- `search` (string — поиск по номеру, клиенту, инвестиции)
- `sort_by` (string: created_at, planned_response_date, client_name)
- `sort_order` (string: asc, desc)

**Response 200:**
```json
{
  "data": [
    {
      "id": 1,
      "request_number": "ZAP-2026-00001",
      "status": "in_progress",
      "client_name": "ABC Development Sp. z o.o.",
      "contact_person": "Anna Nowak",
      "phone": "+48 123 456 789",
      "email": "anna@abc.pl",
      "investment_name": "Osiedle Słoneczne - Etap II",
      "object_type": "residential",
      "installation_types": "IE,IT",
      "address": "ul. Kwiatowa 15, Poznań",
      "planned_response_date": "2026-02-13",
      "assigned_user": {
        "id": 3,
        "first_name": "Piotr",
        "last_name": "Wiśniewski"
      },
      "created_at": "2026-02-06T10:30:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "per_page": 20,
    "total": 45,
    "total_pages": 3
  }
}
```

### POST /requests

**Назначение:** Создание нового запроса.

**Request Body:**
```json
{
  "client_name": "ABC Development Sp. z o.o.",
  "contact_person": "Anna Nowak",
  "phone": "+48 123 456 789",
  "email": "anna@abc.pl",
  "investment_name": "Osiedle Słoneczne - Etap II",
  "object_type": "residential",
  "installation_types": "IE,IT",
  "address": "ul. Kwiatowa 15, Poznań",
  "planned_response_date": "2026-02-13",
  "notes": "Klient oczekuje kosztorysu do końca tygodnia",
  "request_source": "email",
  "assigned_user_id": 3
}
```

**Response 201:**
```json
{
  "id": 46,
  "request_number": "ZAP-2026-00046",
  "status": "new",
  "created_at": "2026-02-06T14:00:00Z"
}
```

**Response 400:**
```json
{
  "error": "VALIDATION_ERROR",
  "message": "Błędy walidacji",
  "details": {
    "client_name": "Pole jest wymagane",
    "phone": "Nieprawidłowy format numeru telefonu"
  }
}
```

### GET /requests/{id}

**Response 200:** Полный объект запроса, включая вложенные данные (forms, estimates, proposals).

### PUT /requests/{id}

**Назначение:** Обновление запроса.

### PATCH /requests/{id}/status

**Назначение:** Смена статуса запроса.

**Request Body:**
```json
{
  "status": "in_progress",
  "comment": "Zaczynam pracę nad kosztorysem"
}
```

**Response 200:**
```json
{
  "id": 1,
  "status": "in_progress",
  "updated_at": "2026-02-06T14:05:00Z"
}
```

**Response 400:**
```json
{
  "error": "INVALID_STATUS_TRANSITION",
  "message": "Nie można zmienić statusu z 'new' na 'estimate_approved'"
}
```

### DELETE /requests/{id}

**Авторизация:** Только Администратор.

**Response 204:** No Content.

**Response 403:**
```json
{
  "error": "FORBIDDEN",
  "message": "Brak uprawnień do usunięcia zapytania"
}
```

## 7.3. Формуляры (Forms)

### POST /requests/{request_id}/forms

**Назначение:** Создание формуляра для запроса.

**Request Body:**
```json
{
  "form_type": "MIESZK-IE"
}
```

### GET /requests/{request_id}/forms/{form_id}

**Response 200:** Формуляр со всеми данными (шапка + отметки).

### PUT /requests/{request_id}/forms/{form_id}/general-data

**Назначение:** Сохранение шапки формуляра.

**Request Body:**
```json
{
  "apartments_count": "120 mieszkań, 8500 m²",
  "ext_wall_type": "Cegła ceramiczna",
  "int_wall_type": "Gipskarton",
  "ceiling_height": 2.80,
  "consumable_material": "Standard"
}
```

### POST /requests/{request_id}/forms/{form_id}/answers

**Назначение:** Сохранение отметок (пакетное).

**Request Body:**
```json
{
  "answers": [
    { "room_code": "GARAZ_OSWIETLENIE", "room_group": "Garaż podziemny", "work_type_code": "BRUZDOWANIE", "work_category": "Przygotowanie", "is_marked": true },
    { "room_code": "GARAZ_OSWIETLENIE", "room_group": "Garaż podziemny", "work_type_code": "OKABLOWANIE_PODTYNK", "work_category": "Okablowanie", "is_marked": true },
    { "room_code": "GARAZ_GNIAZDA", "room_group": "Garaż podziemny", "work_type_code": "BRUZDOWANIE", "work_category": "Przygotowanie", "is_marked": false }
  ]
}
```

### GET /forms/template/{form_type}

**Назначение:** Получение шаблона матрицы формуляра (структура строк и столбцов).

**Response 200:**
```json
{
  "form_type": "MIESZK-IE",
  "title": "FORMULARZ WYKONYWANYCH PRAC - MIESZKANIA I BIUROWCE - IE",
  "general_fields": [
    { "code": "apartments_count", "label": "Ilość mieszkań oraz powierzchnia", "type": "text", "required": true },
    { "code": "ext_wall_type", "label": "Rodzaj ścian zewn.", "type": "text", "required": true },
    { "code": "int_wall_type", "label": "Rodzaj ścian wewn.", "type": "text", "required": true },
    { "code": "ceiling_height", "label": "Wysokość sufitu", "type": "decimal", "required": true },
    { "code": "consumable_material", "label": "Materiał eksploatacyjny", "type": "text", "required": false }
  ],
  "room_groups": [
    {
      "code": "UZIOM",
      "name": "Uziom",
      "rooms": [
        { "code": "UZIOM_FUND", "name": "Uziom fundamentowy" }
      ]
    },
    {
      "code": "GARAZ",
      "name": "Garaż podziemny",
      "rooms": [
        { "code": "GARAZ_OSWIETLENIE_PODST", "name": "Oświetlenie podstawowe" },
        { "code": "GARAZ_OSWIETLENIE_EWAK", "name": "Oświetlenie ewakuacyjne" },
        { "code": "GARAZ_GNIAZDA", "name": "Gniazda" }
      ]
    }
  ],
  "work_categories": [
    {
      "code": "PRZYGOTOWANIE",
      "name": "Przygotowanie",
      "work_types": [
        { "code": "BRUZDOWANIE", "name": "Bruzdowanie", "description": "Wykonanie bruzd za pomocą odpowiednich narzędzi..." },
        { "code": "WYKONCZENIE_BRUZD", "name": "Wykończenie bruzd", "description": "Zakrycie bruzd po ułożeniu w nich kabli..." }
      ]
    }
  ]
}
```

## 7.4. Сметы (Estimates)

### POST /requests/{request_id}/estimates/generate

**Назначение:** Автоматическое формирование сметы на основании формуляра.

**Request Body:**
```json
{
  "form_id": 5
}
```

**Response 201:**
```json
{
  "id": 12,
  "estimate_number": "KSZ-2026-00012",
  "items_count": 85,
  "items_auto": 78,
  "items_manual_required": 7,
  "total_works": 0,
  "total_materials": 0,
  "message": "Kosztorys wygenerowany. 7 pozycji wymaga ręcznego uzupełnienia."
}
```

### GET /estimates/{id}

**Response 200:** Полный объект сметы со всеми позициями.

### PUT /estimates/{id}/items/{item_id}

**Назначение:** Обновление позиции сметы.

**Request Body:**
```json
{
  "quantity": 150,
  "unit_price_work": 25.00,
  "material_name": "Kabel YDYp 3x2,5mm²",
  "unit_price_material": 4.50
}
```

**Response 200:**
```json
{
  "id": 234,
  "quantity": 150,
  "unit_price_work": 25.00,
  "total_work": 3750.00,
  "unit_price_material": 4.50,
  "total_material": 675.00,
  "total_item": 4425.00
}
```

### POST /estimates/{id}/items

**Назначение:** Добавление новой позиции.

### DELETE /estimates/{id}/items/{item_id}

**Назначение:** Удаление позиции (мягкое).

### POST /estimates/{id}/recalculate

**Назначение:** Пересчёт итогов сметы.

**Response 200:**
```json
{
  "total_works": 125430.00,
  "total_materials": 89200.00,
  "total_equipment": 5600.00,
  "subtotal_net": 220230.00,
  "vat_amount": 50652.90,
  "total_gross": 270882.90
}
```

## 7.5. Коммерческие предложения (КП)

### POST /estimates/{estimate_id}/proposals/generate

**Request Body:**
```json
{
  "detail_level": "aggregated",
  "validity_days": 30,
  "payment_terms": "Płatność w 3 ratach: 30% przedpłata, 40% w trakcie, 30% po zakończeniu",
  "execution_terms": "Termin realizacji: 12 tygodni od podpisania umowy"
}
```

**Response 201:**
```json
{
  "id": 8,
  "kp_number": "KP-2026-00008-v1",
  "file_urls": {
    "pdf": "/files/proposals/KP-2026-00008-v1.pdf",
    "xlsx": "/files/proposals/KP-2026-00008-v1.xlsx",
    "docx": "/files/proposals/KP-2026-00008-v1.docx"
  }
}
```

### GET /proposals/{id}/download/{format}

**Назначение:** Скачивание файла КП.

**Path Parameters:** format = pdf | xlsx | docx.

**Response 200:** Файл с соответствующим Content-Type.

## 7.6. Справочники

### GET /work-types

Query: page, per_page, search, category, is_active. Response: пагинированный список.

### POST /work-types
### PUT /work-types/{id}
### DELETE /work-types/{id} (мягкое удаление — is_active = false)

Аналогичные эндпоинты для: `/materials`, `/equipment`, `/units`, `/template-tasks`, `/price-lists`.

### GET /template-tasks/{id}

**Response 200:**
```json
{
  "id": 15,
  "code": "TMPL-GNZD-001",
  "name": "Montaż gniazda wtykowego",
  "work_type": { "id": 12, "name": "Montaż gniazda", "category": "Montaż odbiorników" },
  "unit": { "id": 1, "code": "szt", "name": "sztuka" },
  "labor_hours": 0.5,
  "expected_result": "Stabilnie zainstalowane gniazdo wtykowe zgodnie z projektem",
  "materials": [
    { "material": { "id": 45, "name": "Gniazdo Schneider Sedna 230V" }, "quantity_coefficient": 1.0 },
    { "material": { "id": 78, "name": "Puszka podtynkowa Ø60mm" }, "quantity_coefficient": 1.0 }
  ],
  "equipment": []
}
```

## 7.7. Маппинг

### GET /mapping-rules

**Query:** form_type (обязательный), room_code, work_type_code.

### POST /mapping-rules
### PUT /mapping-rules/{id}
### DELETE /mapping-rules/{id}

## 7.8. Отчёты

### GET /reports/requests

**Query:** date_from, date_to, status, object_type, assigned_user_id.

**Response 200:**
```json
{
  "period": { "from": "2026-01-01", "to": "2026-02-06" },
  "total_requests": 45,
  "by_status": { "new": 5, "in_progress": 12, "estimate_approved": 8, "kp_sent": 15, "closed": 5 },
  "avg_processing_days": 3.2,
  "overdue_count": 3,
  "overdue_percentage": 6.7
}
```

### GET /reports/estimates
### GET /reports/proposals
### GET /reports/analytics/missed-items

---

# 8. АЛГОРИТМЫ И БИЗНЕС-ЛОГИКА

## 8.1. Алгоритм маппинга ответов формуляра на позиции сметы

```
ВХОД: form_id (ID заполненного формуляра)
ВЫХОД: список позиций сметы (estimate_items)

1. Получить form = SELECT * FROM forms WHERE id = form_id
2. Получить answers = SELECT * FROM form_answers WHERE form_id = form_id AND is_marked = TRUE
3. Получить active_price_list = SELECT * FROM price_lists WHERE is_active = TRUE AND valid_from <= NOW() AND (valid_to IS NULL OR valid_to >= NOW()) ORDER BY valid_from DESC LIMIT 1
4. Инициализировать items = []
5. position_counter = 1

6. ДЛЯ КАЖДОГО answer В answers:
   6.1. Найти mapping = SELECT * FROM mapping_rules WHERE form_type = form.form_type AND room_code = answer.room_code AND work_type_code = answer.work_type_code AND is_active = TRUE
   
   6.2. ЕСЛИ mapping НАЙДЕН:
        6.2.1. task = SELECT * FROM template_tasks WHERE id = mapping.template_task_id
        6.2.2. task_materials = SELECT * FROM template_task_materials WHERE template_task_id = task.id
        6.2.3. work_price = SELECT unit_price FROM price_list_items WHERE price_list_id = active_price_list.id AND item_type = 'work' AND item_id = task.work_type_id
        
        6.2.4. Создать item:
               item.position_number = position_counter++
               item.room_group = answer.room_group
               item.installation_element = room_name_by_code(answer.room_code)
               item.task_description = task.name
               item.unit_id = task.unit_id
               item.unit_price_work = work_price ИЛИ 0
               item.expected_result = task.expected_result
               item.source = 'auto'
               item.template_task_id = task.id
               item.mapping_rule_id = mapping.id
        
        6.2.5. ДЛЯ КАЖДОГО tm В task_materials:
               material_price = SELECT unit_price FROM price_list_items WHERE price_list_id = active_price_list.id AND item_type = 'material' AND item_id = tm.material_id
               
               Если это первый материал → item.material_name = material.name, item.unit_price_material = material_price
               Если материалов > 1 → создать отдельную позицию для каждого дополнительного материала
        
        6.2.6. Добавить item в items
   
   6.3. ЕСЛИ mapping НЕ НАЙДЕН:
        6.3.1. Создать item с пустыми полями:
               item.position_number = position_counter++
               item.room_group = answer.room_group
               item.installation_element = room_name_by_code(answer.room_code)
               item.task_description = "[WYMAGA RĘCZNEGO WPROWADZENIA] " + work_type_name_by_code(answer.work_type_code)
               item.source = 'manual'
        6.3.2. Добавить item в items

7. Сохранить все items в таблицу estimate_items
8. ВЕРНУТЬ items
```

**Пример:**

Вход: Формуляр MIESZK-IE, отмечены:
- Квартиры → Розетки × Штробление
- Квартиры → Розетки × Прокладка кабелей подштукатурная
- Квартиры → Розетки × Монтаж устройства подштукатурного

Результат:

| № | Группа | Элемент | Задание | Материал | ЕИ | Кол-во | Цена работы | Цена мат-ла |
|---|---|---|---|---|---|---|---|---|
| 1 | Квартиры | Розетки | Штробление под розетку | — | п.м. | — | 25,00 | 0 |
| 2 | Квартиры | Розетки | Прокладка кабеля YDYp подштукатурно | Кабель YDYp 3×2,5 мм² | п.м. | — | 15,00 | 4,50 |
| 3 | Квартиры | Розетки | Монтаж розетки | Розетка Schneider Sedna 230V | шт. | — | 35,00 | 28,00 |
| 4 | Квартиры | Розетки | Монтаж подрозетника | Подрозетник Ø60 мм | шт. | — | 12,00 | 3,50 |

## 8.2. Алгоритм расчёта стоимости

```
ДЛЯ КАЖДОЙ позиции estimate_item:
  total_work = quantity × unit_price_work
  total_material = quantity × unit_price_material
  total_item = total_work + total_material

ДЛЯ сметы estimate:
  total_works = SUM(total_work) по всем позициям
  total_materials = SUM(total_material) по всем позициям
  total_equipment = SUM(quantity × unit_price) по всем записям estimate_equipment
  subtotal_net = total_works + total_materials + total_equipment
  vat_amount = subtotal_net × (vat_rate / 100)
  total_gross = subtotal_net + vat_amount
```

## 8.3. Алгоритм проверки полноты заполнения

```
ВХОД: form_id

1. Получить все отметки: answers = SELECT * FROM form_answers WHERE form_id AND is_marked = TRUE
2. Сгруппировать по room_code → room_works

3. ДЛЯ КАЖДОГО room В room_works:
   3.1. ЕСЛИ есть отметка в категории «Монтаж приёмников» НО НЕТ в «Прокладка кабелей»:
        → Добавить предупреждение: "Для {room} отмечен монтаж, но не отмечена прокладка кабелей"
   
   3.2. ЕСЛИ есть отметка «Прокладка кабелей подштукатурная» НО НЕТ «Штробление»:
        → Добавить предупреждение: "Для {room} отмечена подштукатурная прокладка, но не отмечено штробление"
   
   3.3. ЕСЛИ есть отметка «Материал основной» НО НЕТ ни одной работы в той же категории:
        → Добавить предупреждение: "Для {room} отмечен материал, но не отмечены работы"

4. ВЕРНУТЬ список предупреждений (warnings) и ошибок (errors)
```

## 8.4. Алгоритм выявления забытых позиций

Система анализирует исторические данные:

```
1. Для каждого шаблонного задания подсчитать:
   - Сколько раз оно было автоматически добавлено в сметы
   - Сколько раз было затем удалено специалистом
   - Сколько раз специалист вручную добавлял позицию, которой нет в маппинге

2. ЕСЛИ частота ручного добавления > 30% от общего числа смет данного типа:
   → Рекомендация: "Рассмотрите добавление маппинга для {работа} в {помещение}"

3. ЕСЛИ частота удаления > 50% от автоматических добавлений:
   → Рекомендация: "Рассмотрите удаление маппинга для {работа} в {помещение}"
```

---

# 9. ТРЕБОВАНИЯ К ИНТЕГРАЦИЯМ

## 9.1. Интеграция с Excel

- **Импорт прайс-листов:** Загрузка файла .xlsx с ценами. Формат: Код | Наименование | Единица | Цена. Система валидирует, выводит превью, после подтверждения обновляет прайс-лист.
- **Экспорт сметы:** Генерация .xlsx по шаблону (столбцы из Szablon do kosztorysów.xlsx).
- **Экспорт формуляра:** Генерация .xlsx, повторяющего структуру оригинальных формуляров.

## 9.2. Email-уведомления

| Событие | Получатель | Шаблон |
|---|---|---|
| Новый запрос | Ответственный специалист | «Новый запрос ZAP-YYYY-NNNNN от клиента [имя]» |
| Смета на утверждение | Руководитель | «Смета KSZ-YYYY-NNNNN ожидает утверждения» |
| Смета утверждена | Специалист + Менеджер | «Смета KSZ-YYYY-NNNNN утверждена» |
| Смета возвращена | Специалист | «Смета KSZ-YYYY-NNNNN возвращена на доработку» |
| Срок ответа истекает | Ответственный | «Срок ответа по запросу ZAP-YYYY-NNNNN истекает через 1 день» |

---

# 10. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

## 10.1. Производительность

- Время отклика страницы: не более 2 секунд.
- Время генерации сметы (маппинг): не более 5 секунд для формуляра с 500 отметками.
- Время генерации КП (PDF): не более 10 секунд.
- Одновременных пользователей: до 50.

## 10.2. Безопасность

- Аутентификация: JWT с refresh-токеном. Срок жизни access-токена: 1 час. Refresh: 30 дней.
- Авторизация: RBAC (Role-Based Access Control).
- Шифрование: HTTPS (TLS 1.2+). Пароли хешируются bcrypt (cost factor ≥ 12).
- Аудит: Все действия логируются в audit_log.
- Защита от CSRF, XSS, SQL injection.
- Rate limiting: 100 запросов в минуту на пользователя.

## 10.3. Надёжность

- Доступность: 99,5% (без учёта планового обслуживания).
- Резервное копирование БД: ежедневно, хранение 30 дней.
- Восстановление: RPO = 24 часа, RTO = 4 часа.

## 10.4. Совместимость

- Браузеры: Chrome 90+, Firefox 90+, Edge 90+, Safari 14+.
- Минимальное разрешение экрана: 1280×720.
- Рекомендуемое: 1920×1080.

---

# 11. ТЕХНОЛОГИЧЕСКИЙ СТЕК

## 11.1. Рекомендуемый стек

| Уровень | Технология | Обоснование |
|---|---|---|
| Frontend | React 18+ с TypeScript | Компонентная архитектура, мощная экосистема |
| UI-фреймворк | Ant Design или MUI | Готовые компоненты для таблиц, форм, деревьев |
| Управление состоянием | Zustand или Redux Toolkit | Централизованное управление |
| Backend | Node.js (NestJS) или Python (FastAPI) | Типизация, встроенная документация API |
| ORM | Prisma (Node.js) или SQLAlchemy (Python) | Миграции, типобезопасность |
| БД | PostgreSQL 15+ | JSONB, полнотекстовый поиск, надёжность |
| Кэширование | Redis | Сессии, кэш справочников |
| Генерация документов | xlsx (Node.js) / openpyxl (Python), docx, puppeteer (PDF) | Гибкая генерация в нужных форматах |
| Хранилище файлов | S3-совместимое (MinIO / AWS S3) | Масштабируемость |
| CI/CD | GitHub Actions / GitLab CI | Автоматизация деплоя |
| Контейнеризация | Docker + Docker Compose | Воспроизводимость окружения |
| Хостинг | VPS (Hetzner / OVH) или AWS | Близость к пользователям в Польше |

---

# 12. ЭТАПЫ РАЗРАБОТКИ И ВНЕДРЕНИЯ

## 12.1. Разбивка на этапы

### Этап 1: MVP (8 недель)

**Спринт 1–2 (2 недели):**
- Настройка инфраструктуры (Docker, CI/CD, БД).
- Модуль аутентификации и авторизации.
- CRUD пользователей и ролей.

**Спринт 3–4 (2 недели):**
- Модуль запросов (CRUD, статусы, фильтрация).
- Модуль справочников (работы, материалы, техника, ЕИ).

**Спринт 5–6 (2 недели):**
- Электронный формуляр работ (все 4 типа).
- Сохранение и загрузка формуляра.
- Настройка маппинга.

**Спринт 7–8 (2 недели):**
- Алгоритм маппинга и автоматическое формирование сметы.
- Редактирование сметы.
- Расчёт итогов.

### Этап 2: КП и отчёты (4 недели)

**Спринт 9–10:** Генерация КП (PDF, Excel, Word). Версионность.

**Спринт 11–12:** Модуль отчётности. Email-уведомления. Импорт прайс-листов из Excel.

### Этап 3: Оптимизация (4 недели)

**Спринт 13–14:** Аналитика ошибок и рекомендации. Дашборд.

**Спринт 15–16:** Тестирование (UAT), исправление дефектов, документация.

## 12.2. План тестирования

- Юнит-тесты: покрытие > 70% для бизнес-логики.
- Интеграционные тесты: все API-эндпоинты.
- E2E тесты: основные сценарии (Cypress / Playwright).
- Нагрузочное тестирование: 50 одновременных пользователей.
- UAT: приёмочное тестирование с реальными пользователями (2 недели).

## 12.3. План миграции данных

- Импорт существующих справочников работ из Excel-формуляров.
- Импорт словаря (лист «Słownik») в справочник работ.
- Настройка маппинга на основе структуры существующих формуляров.
- Импорт текущих прайс-листов.

## 12.4. План обучения

- Подготовка руководства пользователя (с скриншотами).
- Видео-инструкции для каждого модуля.
- 2 тренинговые сессии по 2 часа для специалистов.
- 1 тренинговая сессия для руководителей.
- Период параллельной работы (старый + новый процесс): 2 недели.

---

# 13. РИСКИ И ОГРАНИЧЕНИЯ

## 13.1. Технические риски

| Риск | Вероятность | Влияние | Митигация |
|---|---|---|---|
| Неполный маппинг при старте | Высокая | Среднее | Поэтапное заполнение маппинга. Возможность ручного ввода позиций. |
| Сложность формуляра (500+ ячеек) | Средняя | Среднее | Оптимизация рендеринга (виртуализация таблицы). |
| Некорректная генерация PDF | Средняя | Низкое | Использование Puppeteer / WeasyPrint. Шаблоны КП с тестированием. |

## 13.2. Бизнес-риски

| Риск | Вероятность | Влияние | Митигация |
|---|---|---|---|
| Сопротивление пользователей | Средняя | Высокое | Вовлечение ключевых пользователей на этапе проектирования. Обучение. |
| Изменение требований в процессе | Высокая | Среднее | Agile-подход. Итеративная разработка. MVP-первый релиз. |
| Неточные цены в справочниках | Высокая | Высокое | Обязательная проверка руководителем. Уведомления об устаревших прайс-листах. |

---

# 14. ПРИЛОЖЕНИЯ

## 14.1. Пример заполненного формуляра (фрагмент)

**Формуляр: MIESZK-IE (Жилые дома — Электроустановки)**

**Шапка:**
- Количество квартир: 120 квартир, 8500 м²
- Тип наружных стен: Кирпич керамический
- Тип внутренних стен: Гипсокартон
- Высота потолка: 2,80 м

**Матрица (фрагмент — Квартиры):**

| Помещение / Элемент | Штробление | Отделка штроб | Прокладка в потолке | Материал осн. | Подштукатурная | На кронштейнах |
|---|---|---|---|---|---|---|
| Квартиры → Розетки | X | X | | X | X | |
| Квартиры → Выключатели | X | X | | X | X | |
| Квартиры → Освещение | | | X | X | | X |
| Квартиры → TM (щит) | | | | X | | |

## 14.2. Пример сметы (фрагмент)

**Инвестиция:** Osiedle Słoneczne — Etap II  
**Номер сметы:** KSZ-2026-00012  

| № | Группа | Элемент | Задание | Материал | ЕИ | Кол-во | Цена раб. | Ст-ть раб. | Цена мат. | Ст-ть мат. | Итого |
|---|---|---|---|---|---|---|---|---|---|---|---|
| 1 | Квартиры | Розетки | Штробление | — | п.м. | 1800 | 25,00 | 45 000 | 0 | 0 | 45 000 |
| 2 | Квартиры | Розетки | Отделка штроб | Гипс | п.м. | 1800 | 18,00 | 32 400 | 2,50 | 4 500 | 36 900 |
| 3 | Квартиры | Розетки | Прокладка кабеля | YDYp 3×2,5 | п.м. | 3600 | 15,00 | 54 000 | 4,50 | 16 200 | 70 200 |
| 4 | Квартиры | Розетки | Монтаж подрозетника | Подрозетник Ø60 | шт. | 960 | 12,00 | 11 520 | 3,50 | 3 360 | 14 880 |
| 5 | Квартиры | Розетки | Монтаж розетки | Schneider Sedna | шт. | 960 | 35,00 | 33 600 | 28,00 | 26 880 | 60 480 |
| ... | | | | | | | | | | | |
| **Итого Квартиры** | | | | | | | | **176 520** | | **50 940** | **227 460** |

## 14.3. Пример КП (структура)

```
╔══════════════════════════════════════════╗
║           [ЛОГОТИП КОМПАНИИ]             ║
║   Firma ElektroMontaż Sp. z o.o.        ║
║   ul. Przykładowa 10, 60-001 Poznań     ║
║   NIP: 123-456-78-90                     ║
╠══════════════════════════════════════════╣
║   OFERTA HANDLOWA nr KP-2026-00008-v1   ║
║   Data: 06.02.2026                       ║
╠══════════════════════════════════════════╣
║   Klient: ABC Development Sp. z o.o.    ║
║   Inwestycja: Osiedle Słoneczne Etap II ║
╠══════════════════════════════════════════╣
║                                          ║
║   [ТАБЛИЦА РАБОТ — агрегированная]       ║
║                                          ║
║   Garaż podziemny ........... 85 400 PLN║
║   Pomieszczenia techniczne .. 42 100 PLN║
║   Klatki schodowe ........... 31 200 PLN║
║   Korytarze ................. 18 500 PLN║
║   Mieszkania ............... 227 460 PLN║
║   Dach ...................... 12 800 PLN║
║   PZT ....................... 35 600 PLN║
║   ─────────────────────────────────────  ║
║   Suma netto: ............. 453 060 PLN  ║
║   VAT 23%: ................ 104 203 PLN  ║
║   SUMA BRUTTO: ............ 557 263 PLN  ║
║                                          ║
║   Ważność oferty: 30 dni                 ║
║   Warunki płatności: 30/40/30            ║
║   Termin realizacji: 12 tygodni          ║
║                                          ║
║   [PODPIS]                               ║
╚══════════════════════════════════════════╝
```

---

**КОНЕЦ ДОКУМЕНТА**

Версия 1.0 | 06.02.2026 | Автор: Система «ЭлектроСмета»
