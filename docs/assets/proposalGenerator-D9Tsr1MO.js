import{s as c}from"./index-DuQfqRAf.js";async function y(i){try{const{data:t,error:u}=await c.from("kosztorys_estimates").select("*").eq("id",i).single();if(u||!t)return null;let s=null;if(t.request_id){const{data:_}=await c.from("kosztorys_requests").select("*").eq("id",t.request_id).single();s=_}const{data:e}=await c.from("kosztorys_estimate_items").select("*").eq("estimate_id",i).order("position_number"),{data:n}=await c.from("kosztorys_estimate_equipment").select("*").eq("estimate_id",i);let o=null;if(t.company_id){const{data:_}=await c.from("companies").select("*").eq("id",t.company_id).single();o=_}const a=t.subtotal_net||t.total_gross||0,r=t.margin_percent||0,l=t.discount_percent||0,m=a*r/100,d=a+m,p=d*l/100,f=d-p;return{estimate:{...t,request:s},request:s,items:e||[],equipment:n||[],totals:{workTotal:t.total_works||0,materialTotal:t.total_materials||0,equipmentTotal:t.total_equipment||0,laborHoursTotal:0,subtotal:a,marginPercent:r,marginAmount:m,discountPercent:l,discountAmount:p,finalTotal:t.total_gross||f},company:o}}catch(t){return console.error("Error loading proposal data:",t),null}}async function z(i){const t=await y(i);if(!t)return null;const u=t.items.reduce((e,n)=>{const o=n.room_name||"Inne";return e[o]||(e[o]=[]),e[o].push(n),e},{}),s=Object.entries(u).map(([e,n],o)=>({id:`kosztorys-section-${o}`,offer_id:"",name:e,description:"",sort_order:o,created_at:"",updated_at:"",isExpanded:!0,items:n.map((a,r)=>({id:`kosztorys-item-${o}-${r}`,offer_id:"",section_id:`kosztorys-section-${o}`,name:a.work_name||a.work_code||`Pozycja ${r+1}`,description:a.work_code||"",quantity:a.quantity,unit:a.unit,unit_price:a.unit_price,total_price:a.total_price,sort_order:r,is_optional:!1,created_at:"",updated_at:"",isNew:!0}))}));return t.equipment.length>0&&s.push({id:"kosztorys-equipment-section",offer_id:"",name:"Sprzęt i urządzenia",description:"",sort_order:s.length,created_at:"",updated_at:"",isExpanded:!0,items:t.equipment.map((e,n)=>({id:`kosztorys-eq-${n}`,offer_id:"",section_id:"kosztorys-equipment-section",name:e.equipment_name||e.equipment_code||`Sprzęt ${n+1}`,description:e.equipment_code||"",quantity:e.quantity,unit:e.unit,unit_price:e.unit_price,total_price:e.total_price,sort_order:n,is_optional:!1,created_at:"",updated_at:"",isNew:!0}))}),{offerData:{name:`Oferta - ${t.request?.investment_name||"Kosztorys"}`,project_id:"",client_id:"",valid_until:new Date(Date.now()+720*60*60*1e3).toISOString().split("T")[0],discount_percent:t.totals.discountPercent,discount_amount:t.totals.discountAmount,notes:`Na podstawie kosztorysu v${t.estimate.version}
Klient: ${t.request?.client_name||""}
Inwestycja: ${t.request?.investment_name||""}`,internal_notes:`Importowano z kosztorysu ID: ${i}`},sections:s}}export{z as convertEstimateToOfferData,y as loadProposalData};
