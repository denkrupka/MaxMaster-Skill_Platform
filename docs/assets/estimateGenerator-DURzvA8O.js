import{s as c}from"./index-CL-unvW0.js";async function x(u,h,w,f){const t={success:!1,items:[],materials:[],equipment:[],totals:{workTotal:0,materialTotal:0,equipmentTotal:0,laborHoursTotal:0,grandTotal:0},warnings:[],errors:[]};try{const{data:s,error:i}=await c.from("kosztorys_forms").select("*").eq("id",u).single();if(i||!s)return t.errors.push("Nie można załadować formularza"),t;const{data:T,error:E}=await c.from("kosztorys_form_answers").select("*").eq("form_id",u).eq("is_marked",!0);if(E)return t.errors.push("Nie można załadować odpowiedzi formularza"),t;if(!T||T.length===0)return t.warnings.push("Formularz nie zawiera żadnych wypełnionych pozycji"),t.success=!0,t;const{data:$,error:M}=await c.from("kosztorys_mapping_rules").select(`
        *,
        template_task:kosztorys_template_tasks(
          *,
          work_type:kosztorys_work_types(*),
          materials:kosztorys_template_task_materials(
            *,
            material:kosztorys_materials(*)
          ),
          equipment:kosztorys_template_task_equipment(
            *,
            equipment:kosztorys_equipment(*)
          )
        )
      `).eq("form_type",s.form_type).eq("is_active",!0).order("priority",{ascending:!1});if(M)return t.errors.push("Nie można załadować reguł mapowania"),t;let k=null,q=[];if(f){const{data:a}=await c.from("kosztorys_price_lists").select("*").eq("id",f).maybeSingle();k=a}else{const a=new Date().toISOString().split("T")[0],{data:o}=await c.from("kosztorys_price_lists").select("*").eq("company_id",w).eq("is_active",!0).lte("valid_from",a).or(`valid_to.is.null,valid_to.gte.${a}`).order("valid_from",{ascending:!1}).limit(1).maybeSingle();k=o}if(k){const{data:a}=await c.from("kosztorys_price_list_items").select("*").eq("price_list_id",k.id);q=a||[]}else t.warnings.push("Brak aktywnego cennika - zostaną użyte ceny domyślne");const g=(a,o,_)=>q.find(e=>e.item_type===a&&e.item_id===o)?.unit_price??_,p=new Map,z=new Map;for(const a of T){const o=a.work_code||a.work_type_code,_=($||[]).filter(n=>{const r=n.room_code===a.room_code||n.room_code==="*",l=n.work_type_code===o||n.work_code===o||n.work_type_code==="*";return r&&l});if(_.length===0){t.warnings.push(`Brak reguły mapowania dla: ${a.room_code} + ${o}`);continue}const m=_[0],e=m.template_task;if(!e){t.warnings.push(`Brak szablonu dla reguły: ${a.room_code} + ${o}`);continue}const b=(a.value??1)*(m.multiplier||1)*(e.base_quantity||1),I=g("work",e.id,e.work_type?.labor_hours*50||0),B=(e.labor_hours||0)*b;let P=0;if(e.materials)for(const n of e.materials){const r=n.material;if(!r)continue;const l=b*(n.quantity||1),v=g("material",r.id,r.default_price||0),d=l*v;P+=d;const y=r.id;if(p.has(y)){const S=p.get(y);S.quantity+=l,S.total_price+=d}else p.set(y,{material_id:r.id,material_code:r.code,material_name:r.name,unit:r.unit,quantity:l,unit_price:v,total_price:d})}let A=0;if(e.equipment)for(const n of e.equipment){const r=n.equipment;if(!r)continue;const l=b*(n.quantity||1),v=g("equipment",r.id,r.default_price||0),d=l*v;A+=d;const y=r.id;if(z.has(y)){const S=z.get(y);S.quantity+=l,S.total_price+=d}else z.set(y,{equipment_id:r.id,equipment_code:r.code,equipment_name:r.name,unit:r.unit,quantity:l,unit_price:v,total_price:d})}const F={work_type_id:e.work_type_id,work_code:e.code,work_name:e.name,room_code:a.room_code,room_name:a.room_name||a.room_group||a.room_code,unit:e.work_type?.unit||"szt",quantity:b,unit_price:I,total_price:b*I,labor_hours:B,material_cost:P,equipment_cost:A,source_template_id:e.id,source_answer_id:a.id};t.items.push(F)}return t.materials=Array.from(p.values()),t.equipment=Array.from(z.values()),t.totals.workTotal=t.items.reduce((a,o)=>a+o.total_price,0),t.totals.materialTotal=t.materials.reduce((a,o)=>a+o.total_price,0),t.totals.equipmentTotal=t.equipment.reduce((a,o)=>a+o.total_price,0),t.totals.laborHoursTotal=t.items.reduce((a,o)=>a+o.labor_hours,0),t.totals.grandTotal=t.totals.workTotal+t.totals.materialTotal+t.totals.equipmentTotal,t.success=!0,t}catch(s){return t.errors.push(`Błąd generowania: ${s.message}`),t}}async function C(u,h,w,f,t,s){try{const i=new Date,T=i.getFullYear(),E=String(i.getMonth()+1).padStart(2,"0"),$=String(i.getDate()).padStart(2,"0"),M=Math.floor(Math.random()*1e3).toString().padStart(3,"0"),k=`KSZ-${T}${E}${$}-${M}`,q=t.totals.workTotal+t.totals.materialTotal+t.totals.equipmentTotal,g=23,p=q*(g/100),z=q+p,{data:a,error:o}=await c.from("kosztorys_estimates").insert({request_id:u,form_id:h,company_id:w,estimate_number:k,created_by_id:f,status:"draft",version:1,vat_rate:g,total_works:t.totals.workTotal,total_materials:t.totals.materialTotal,total_equipment:t.totals.equipmentTotal,subtotal_net:q,vat_amount:p,total_gross:z}).select().single();if(o||!a)return{success:!1,error:o?.message||"Nie można utworzyć kosztorysu"};if(t.items.length>0){const _=t.items.map((e,N)=>({estimate_id:a.id,position_number:N+1,room_group:e.room_name||"Ogólne",installation_element:e.work_code||"Pozycja",task_description:e.work_name||"Prace",quantity:e.quantity,unit_price_work:e.unit_price,total_work:e.total_price,unit_price_material:e.material_cost>0&&e.quantity>0?e.material_cost/e.quantity:0,total_material:e.material_cost,total_item:e.total_price+e.material_cost+e.equipment_cost,source:"auto",template_task_id:e.source_template_id||null})),{error:m}=await c.from("kosztorys_estimate_items").insert(_);m&&console.error("Error inserting estimate items:",m)}if(t.equipment.length>0){const _=t.equipment.map(e=>({estimate_id:a.id,equipment_id:e.equipment_id,quantity:e.quantity,unit_price:e.unit_price,total:e.total_price})),{error:m}=await c.from("kosztorys_estimate_equipment").insert(_);m&&console.error("Error inserting estimate equipment:",m)}return await c.from("kosztorys_requests").update({status:"estimate_generated"}).eq("id",u),{success:!0,estimateId:a.id}}catch(i){return{success:!1,error:i.message}}}async function H(u,h,w,f,t){const s=await x(u,h,w,t);if(!s.success)return s;const i=await C(h,u,w,f,s);return i.success?s.estimateId=i.estimateId:(s.errors.push(i.error||"Nie można zapisać kosztorysu"),s.success=!1),s}export{H as generateAndSaveEstimate,x as generateEstimateFromForm,C as saveGeneratedEstimate};
